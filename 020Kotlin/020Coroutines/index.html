
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../010Basic/">
      
      
        <link rel="next" href="../../030Android/010Basic/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.8">
    
    
      
        <title>Kotlin协程 - 面试知识库</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kotlin" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="面试知识库" class="md-header__button md-logo" aria-label="面试知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            面试知识库
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Kotlin协程
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换到暗色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换到暗色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换到亮色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换到亮色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../010Java/010Basic/" class="md-tabs__link">
          
  
  Java

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../010Basic/" class="md-tabs__link">
          
  
  Kotlin

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../030Android/010Basic/" class="md-tabs__link">
          
  
  Android

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../040Jetpack/010Basic/" class="md-tabs__link">
          
  
  Jetpack

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../041KMP/010Basic/" class="md-tabs__link">
          
  
  KMP

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../050SystemDesign/010Basic/" class="md-tabs__link">
          
  
  System Design

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="面试知识库" class="md-nav__button md-logo" aria-label="面试知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    面试知识库
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/040MultiThreading/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java多线程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/020DataStructure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java数据结构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/030Algorithm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java算法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/050Pattern/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java设计模式
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Kotlin
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Kotlin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotlin基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Kotlin协程
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Kotlin协程
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      协程的基本使用
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Android
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Android
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../030Android/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../030Android/020SystemSourceCode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android系统源码解析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../030Android/030ThirdSDKSourceCode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android三方源码解析
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Jetpack
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Jetpack
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../040Jetpack/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jetpack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../040Jetpack/020Compose/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compose
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    KMP
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            KMP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../041KMP/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotlin Multi Platform
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    System Design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            System Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../050SystemDesign/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系统设计
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      协程的基本使用
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="kotlin">Kotlin协程<a class="headerlink" href="#kotlin" title="Permanent link">&para;</a></h1>
<h2 id="_1">协程的基本使用<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<h1 id="android">协程在Android平台的基本使用<a class="headerlink" href="#android" title="Permanent link">&para;</a></h1>
<p>协程(Coroutines)是Kotlin提供的一种轻量级线程管理方案，特别适合Android开发中处理异步任务。下面我将介绍协程的基本使用以及在Android中的典型应用场景。</p>
<h2 id="_2">协程的基本概念<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>协程是可挂起(suspend)的计算实例，它可以在不阻塞线程的情况下暂停执行并在稍后恢复。与线程相比，协程更轻量(可以创建数千个而不会影响性能)，且可以通过结构化并发来避免内存泄漏。</p>
<h2 id="android_1">Android中协程的核心类<a class="headerlink" href="#android_1" title="Permanent link">&para;</a></h2>
<h3 id="1-coroutinescope-">1. CoroutineScope - 协程作用域<a class="headerlink" href="#1-coroutinescope-" title="Permanent link">&para;</a></h3>
<p>在Android中常用的协程作用域：</p>
<ul>
<li><strong>GlobalScope</strong>: 全局作用域，生命周期与应用一致，不推荐在常规Android开发中使用</li>
<li><strong>LifecycleScope</strong>: 与Activity/Fragment生命周期绑定</li>
<li><strong>ViewModelScope</strong>: 与ViewModel生命周期绑定</li>
<li><strong>MainScope</strong>: 在主线程运行的协程作用域</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// 在ViewModel中使用</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">MyViewModel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ViewModel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">fetchData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 在这里执行协程代码</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 在Activity中使用</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">MyActivity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">AppCompatActivity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span><span class="w"> </span><span class="n">Bundle?)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>

<span class="w">        </span><span class="n">lifecycleScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 在这里执行协程代码</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2-coroutinedispatcher-">2. CoroutineDispatcher - 协程调度器<a class="headerlink" href="#2-coroutinedispatcher-" title="Permanent link">&para;</a></h3>
<p>Android中常用的调度器：</p>
<ul>
<li><strong>Dispatchers.Main</strong>: 主线程，用于UI操作</li>
<li><strong>Dispatchers.IO</strong>: IO密集型操作(网络请求、数据库访问)</li>
<li><strong>Dispatchers.Default</strong>: CPU密集型操作(排序、复杂计算)</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 执行IO操作</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchFromNetwork</span><span class="p">()</span>

<span class="w">    </span><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">Main</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 回到主线程更新UI</span>
<span class="w">        </span><span class="n">updateUI</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="3-job-">3. Job - 协程任务<a class="headerlink" href="#3-job-" title="Permanent link">&para;</a></h3>
<p>表示一个协程任务，可以用于取消协程或等待协程完成。</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 长时间运行的任务</span>
<span class="p">}</span>

<span class="c1">// 取消协程</span>
<span class="n">job</span><span class="p">.</span><span class="na">cancel</span><span class="p">()</span>
</code></pre></div>
<h3 id="4-deferred-">4. Deferred - 有结果的协程<a class="headerlink" href="#4-deferred-" title="Permanent link">&para;</a></h3>
<p><code>async</code>启动的协程会返回一个<code>Deferred</code>对象，可以通过<code>await()</code>获取结果。</p>
<div class="highlight"><pre><span></span><code><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">deferred1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fetchData1</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">deferred2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fetchData2</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deferred1</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">result2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deferred2</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 合并结果</span>
<span class="w">    </span><span class="n">showResult</span><span class="p">(</span><span class="n">result1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result2</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="android_2">Android中协程的典型使用场景<a class="headerlink" href="#android_2" title="Permanent link">&para;</a></h2>
<h3 id="1">1. 网络请求<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">retrofitService</span><span class="p">.</span><span class="na">getUserData</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">_uiState</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UiState</span><span class="p">.</span><span class="na">Success</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">Exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">_uiState</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UiState</span><span class="p">.</span><span class="na">Error</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="na">message</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2">2. 数据库操作<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">insertUser</span><span class="p">(</span><span class="n">user</span><span class="p">:</span><span class="w"> </span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">userDao</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">getUsers</span><span class="p">():</span><span class="w"> </span><span class="n">LiveData</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">userDao</span><span class="p">.</span><span class="na">getUsers</span><span class="p">().</span><span class="na">asLiveData</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="3">3. 多个并行请求<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">userDeferred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">getUser</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">postsDeferred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">getPosts</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userDeferred</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">posts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postsDeferred</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>

<span class="w">    </span><span class="n">showUserProfile</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">posts</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="4">4. 超时处理<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">withTimeout</span><span class="p">(</span><span class="m">5000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 5秒超时</span>
<span class="w">            </span><span class="n">fetchData</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">showResult</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TimeoutCancellationException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">showTimeoutError</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_3">协程的最佳实践<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>避免使用GlobalScope</strong> - 使用ViewModelScope或LifecycleScope以避免内存泄漏</li>
<li><strong>正确处理异常</strong> - 使用try-catch或CoroutineExceptionHandler处理异常</li>
<li><strong>合理选择调度器</strong> - 根据任务类型选择合适的Dispatcher</li>
<li><strong>避免阻塞操作</strong> - 在协程中不要使用阻塞调用(如Thread.sleep())</li>
<li><strong>使用结构化并发</strong> - 确保协程有明确的生命周期管理</li>
</ol>
<h2 id="livedata">协程与LiveData的结合<a class="headerlink" href="#livedata" title="Permanent link">&para;</a></h2>
<p>Android提供了<code>liveData</code>构建器来方便地将协程与LiveData结合：</p>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">user</span><span class="p">:</span><span class="w"> </span><span class="n">LiveData</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">liveData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">database</span><span class="p">.</span><span class="na">loadUser</span><span class="p">()</span><span class="w"> </span><span class="c1">// 挂起函数</span>
<span class="w">    </span><span class="n">emit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>协程为Android异步编程提供了更简洁、更安全的解决方案，特别是在结合ViewModel和LiveData使用时，能够有效管理生命周期和避免内存泄漏。</p>
</details>
<h2 id="_4">协程的基本理解<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<h1 id="kotlin_1">Kotlin协程解析<a class="headerlink" href="#kotlin_1" title="Permanent link">&para;</a></h1>
<p>Kotlin协程是Kotlin语言提供的一种轻量级线程管理方案，用于简化异步编程和并发操作。下面我将从多个角度对Kotlin协程进行详细解析。</p>
<h2 id="_5">基本概念<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>协程是什么</strong>：</li>
<li>协程是一种轻量级的线程，可以在不阻塞线程的情况下挂起和恢复执行</li>
<li>它不是线程，而是运行在线程上的可挂起计算</li>
<li>
<p>一个线程可以运行多个协程</p>
</li>
<li>
<p><strong>主要特点</strong>：</p>
</li>
<li>轻量：可以在单个线程上运行大量协程</li>
<li>结构化并发：提供明确的生命周期管理和取消机制</li>
<li>挂起函数：使用<code>suspend</code>关键字标记，可以在不阻塞线程的情况下暂停执行</li>
</ol>
<h2 id="_6">核心组件<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>CoroutineScope</strong>：</li>
<li>协程作用域，定义了协程的生命周期范围</li>
<li>常用实现：<code>GlobalScope</code>(全局)、<code>CoroutineScope</code>(自定义)、<code>MainScope</code>(主线程)</li>
<li>
<p>结构化并发的关键，可以取消作用域下所有协程</p>
</li>
<li>
<p><strong>CoroutineContext</strong>：</p>
</li>
<li>协程上下文，包含协程运行的各种元素</li>
<li>
<p>主要组件：</p>
<ul>
<li>Job：控制协程的生命周期</li>
<li>Dispatcher：决定协程在哪个线程上运行</li>
<li>CoroutineName：协程名称(调试用)</li>
<li>ExceptionHandler：异常处理</li>
</ul>
</li>
<li>
<p><strong>Dispatcher</strong>：</p>
</li>
<li>Dispatchers.Default：CPU密集型任务</li>
<li>Dispatchers.IO：IO密集型任务</li>
<li>Dispatchers.Main：Android主线程</li>
<li>
<p>Dispatchers.Unconfined：不限定特定线程</p>
</li>
<li>
<p><strong>Job</strong>：</p>
</li>
<li>表示一个协程任务</li>
<li>可以取消、等待完成、查询状态</li>
<li>
<p>可以形成父子关系，父Job取消会导致所有子Job取消</p>
</li>
<li>
<p><strong>Deferred</strong>：</p>
</li>
<li>继承自Job，表示一个有返回值的异步任务</li>
<li>可以通过<code>await()</code>获取结果</li>
</ol>
<h2 id="_7">基本用法<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="_8">启动协程<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 方式1: launch - 不返回结果</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">).</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 协程体</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello from coroutine&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 方式2: async - 返回Deferred&lt;T&gt;</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">deferred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">Default</span><span class="p">).</span><span class="na">async</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 计算并返回结果</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="w">    </span><span class="s">&quot;Result&quot;</span>
<span class="p">}</span>

<span class="c1">// 获取async结果</span>
<span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deferred</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>
</code></pre></div>
<h3 id="_9">挂起函数<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">fetchUserData</span><span class="p">():</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 模拟网络请求</span>
<span class="w">        </span><span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="w">        </span><span class="n">User</span><span class="p">(</span><span class="s">&quot;John&quot;</span><span class="p">,</span><span class="w"> </span><span class="m">30</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_10">结构化并发<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">loadData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">Main</span><span class="p">).</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fetchUserData</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">posts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fetchUserPosts</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>

<span class="w">            </span><span class="n">updateUI</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">await</span><span class="p">(),</span><span class="w"> </span><span class="n">posts</span><span class="p">.</span><span class="na">await</span><span class="p">())</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">Exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">showError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_11">异常处理<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>try-catch</strong>：
<div class="highlight"><pre><span></span><code><span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">).</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fetchData</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">Exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 处理异常</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>CoroutineExceptionHandler</strong>：
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoroutineExceptionHandler</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Caught </span><span class="si">$</span><span class="n">exception</span><span class="s">&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">handler</span><span class="p">).</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Test exception&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h2 id="_12">协程构建器<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>launch</strong>：</li>
<li>启动一个不返回结果的协程</li>
<li>
<p>返回Job对象，可用于取消或等待</p>
</li>
<li>
<p><strong>async</strong>：</p>
</li>
<li>启动一个返回Deferred<T>的协程</li>
<li>
<p>可以通过await()获取结果</p>
</li>
<li>
<p><strong>runBlocking</strong>：</p>
</li>
<li>阻塞当前线程直到协程执行完成</li>
<li>
<p>主要用于测试或main函数中</p>
</li>
<li>
<p><strong>withContext</strong>：</p>
</li>
<li>切换协程上下文</li>
<li>常用于在不同Dispatcher间切换</li>
</ol>
<h2 id="_13">实际应用场景<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>网络请求</strong>：
<div class="highlight"><pre><span></span><code><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">fetchData</span><span class="p">():</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 执行网络请求</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>数据库操作</strong>：
<div class="highlight"><pre><span></span><code><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">insertUser</span><span class="p">(</span><span class="n">user</span><span class="p">:</span><span class="w"> </span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">database</span><span class="p">.</span><span class="na">userDao</span><span class="p">().</span><span class="na">insert</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>并发任务</strong>：
<div class="highlight"><pre><span></span><code><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">loadData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fetchData1</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">data2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fetchData2</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">combinedData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">combineData</span><span class="p">(</span><span class="n">data1</span><span class="p">.</span><span class="na">await</span><span class="p">(),</span><span class="w"> </span><span class="n">data2</span><span class="p">.</span><span class="na">await</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>超时控制</strong>：
<div class="highlight"><pre><span></span><code><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">fetchWithTimeout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">withTimeout</span><span class="p">(</span><span class="m">3000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">fetchData</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">TimeoutCancellationException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 处理超时</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h2 id="_14">性能优化技巧<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h2>
<ol>
<li>避免在协程中执行阻塞操作，使用适当的Dispatcher</li>
<li>合理使用协程作用域，避免内存泄漏</li>
<li>对于大量并行任务，考虑使用<code>coroutineScope</code>或<code>supervisorScope</code></li>
<li>使用<code>channel</code>或<code>flow</code>处理数据流</li>
<li>避免不必要的协程创建，复用现有的作用域</li>
</ol>
<h2 id="rxjava">与RxJava比较<a class="headerlink" href="#rxjava" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>学习曲线</strong>：协程更简单，概念更少</li>
<li><strong>资源消耗</strong>：协程更轻量</li>
<li><strong>结构化并发</strong>：协程原生支持</li>
<li><strong>操作符丰富度</strong>：RxJava操作符更丰富</li>
<li><strong>背压处理</strong>：RxJava有更好的背压支持</li>
</ol>
<p>Kotlin协程提供了一种更加直观和简洁的方式来处理异步编程，特别适合Kotlin和Android开发。通过结构化并发和挂起函数，可以编写出更清晰、更安全的异步代码。</p>
</details>
<h2 id="_15">协程的技术原理<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<h1 id="kotlin_2">Kotlin协程源码分析<a class="headerlink" href="#kotlin_2" title="Permanent link">&para;</a></h1>
<p>Kotlin协程是Kotlin语言中用于简化异步编程的重要特性。下面从源码角度分析其核心实现机制。</p>
<h2 id="_16">一、协程的基本结构<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h2>
<p>Kotlin协程的核心代码主要在<code>kotlinx.coroutines</code>包中，关键类包括：</p>
<ol>
<li>
<p><strong>Continuation.kt</strong> - 定义协程的续体(Continuation)接口
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nc">Continuation</span><span class="o">&lt;</span><span class="k">in</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">context</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">resumeWith</span><span class="p">(</span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="n">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p><strong>CoroutineContext.kt</strong> - 定义协程上下文
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nc">CoroutineContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 操作符重载和上下文元素管理</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h2 id="_17">二、协程构建器实现<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h2>
<h3 id="1-launch">1. launch构建器<a class="headerlink" href="#1-launch" title="Permanent link">&para;</a></h3>
<p><code>launch</code>是常用的协程构建器，其核心实现：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="n">CoroutineScope</span><span class="p">.</span><span class="nf">launch</span><span class="p">(</span>
<span class="w">    </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EmptyCoroutineContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">start</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoroutineStart</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">,</span>
<span class="w">    </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="n">suspend</span><span class="w"> </span><span class="n">CoroutineScope</span><span class="p">.()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span>
<span class="p">):</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">newContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCoroutineContext</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">coroutine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="na">isLazy</span><span class="p">)</span>
<span class="w">        </span><span class="n">LazyStandaloneCoroutine</span><span class="p">(</span><span class="n">newContext</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">)</span><span class="w"> </span><span class="k">else</span>
<span class="w">        </span><span class="n">StandaloneCoroutine</span><span class="p">(</span><span class="n">newContext</span><span class="p">,</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="n">coroutine</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">coroutine</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">coroutine</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2-async">2. async构建器<a class="headerlink" href="#2-async" title="Permanent link">&para;</a></h3>
<p><code>async</code>返回<code>Deferred</code>对象，允许获取异步结果：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CoroutineScope</span><span class="p">.</span><span class="nf">async</span><span class="p">(</span>
<span class="w">    </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EmptyCoroutineContext</span><span class="p">,</span>
<span class="w">    </span><span class="n">start</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoroutineStart</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">,</span>
<span class="w">    </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="n">suspend</span><span class="w"> </span><span class="n">CoroutineScope</span><span class="p">.()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">T</span>
<span class="p">):</span><span class="w"> </span><span class="n">Deferred</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">newContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newCoroutineContext</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">coroutine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="na">isLazy</span><span class="p">)</span>
<span class="w">        </span><span class="n">LazyDeferredCoroutine</span><span class="p">(</span><span class="n">newContext</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">)</span><span class="w"> </span><span class="k">else</span>
<span class="w">        </span><span class="n">DeferredCoroutine</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">newContext</span><span class="p">,</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="n">coroutine</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">coroutine</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">coroutine</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_18">三、协程调度器实现<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h2>
<p>调度器核心在<code>Dispatchers.kt</code>中：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">actual</span><span class="w"> </span><span class="kd">object</span><span class="w"> </span><span class="nc">Dispatchers</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">actual</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">Default</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineDispatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DefaultScheduler</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">actual</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">Main</span><span class="p">:</span><span class="w"> </span><span class="n">MainCoroutineDispatcher</span><span class="w"> </span><span class="k">get</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MainDispatcherLoader</span><span class="p">.</span><span class="na">dispatcher</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">actual</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">Unconfined</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineDispatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kotlinx</span><span class="p">.</span><span class="na">coroutines</span><span class="p">.</span><span class="na">Unconfined</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">IO</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineDispatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DefaultIoScheduler</span>
<span class="p">}</span>
</code></pre></div>
<p>调度器继承关系：
<div class="highlight"><pre><span></span><code>CoroutineDispatcher
    -&gt; ExperimentalCoroutineDispatcher
    -&gt; ExecutorCoroutineDispatcher
        -&gt; ThreadPoolDispatcher
    -&gt; EventLoop
        -&gt; Unconfined
</code></pre></div></p>
<h2 id="_19">四、协程挂起与恢复机制<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h2>
<h3 id="1_1">1. 挂起函数转换<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>Kotlin编译器会将挂起函数转换为状态机。例如：</p>
<div class="highlight"><pre><span></span><code><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">suspendCoroutine</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">cont</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="c1">// 异步操作</span>
<span class="p">}</span>
</code></pre></div>
<p>会被编译器转换为类似：
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="n">Continuation</span><span class="w"> </span><span class="n">$completion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SafeContinuation</span><span class="w"> </span><span class="n">cont</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SafeContinuation</span><span class="p">(</span><span class="n">IntrinsicsKt</span><span class="p">.</span><span class="na">intercepted</span><span class="p">(</span><span class="n">$completion</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// 异步操作逻辑</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cont</span><span class="p">.</span><span class="na">getResult</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></p>
<h3 id="2-continuation-passing-style-cps">2. Continuation Passing Style (CPS)<a class="headerlink" href="#2-continuation-passing-style-cps" title="Permanent link">&para;</a></h3>
<p>编译器将挂起函数转换为CPS风格，每个挂起点对应一个状态：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 原始代码</span>
<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">fetchData</span><span class="p">():</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchData1</span><span class="p">()</span><span class="w"> </span><span class="c1">// 挂起点1</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">data2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchData2</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span><span class="w"> </span><span class="c1">// 挂起点2</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 转换后类似</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">fetchData</span><span class="p">(</span><span class="n">continuation</span><span class="p">:</span><span class="w"> </span><span class="n">Continuation</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span><span class="p">):</span><span class="w"> </span><span class="kt">Any</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">class</span><span class="w"> </span><span class="nc">FetchDataContinuation</span><span class="p">(...)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ContinuationImpl</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nv">result</span><span class="p">:</span><span class="w"> </span><span class="kt">Any?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nv">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="w">        </span><span class="kd">fun</span><span class="w"> </span><span class="nf">invokeSuspend</span><span class="p">(</span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="kt">Any?</span><span class="p">):</span><span class="w"> </span><span class="kt">Any?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">fetchData</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">cont</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">continuation</span><span class="w"> </span><span class="k">as?</span><span class="w"> </span><span class="n">FetchDataContinuation</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="n">FetchDataContinuation</span><span class="p">(</span><span class="n">continuation</span><span class="p">)</span>

<span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">cont</span><span class="p">.</span><span class="na">label</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="m">0</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cont</span><span class="p">.</span><span class="na">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchData1</span><span class="p">(</span><span class="n">cont</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">COROUTINE_SUSPENDED</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">COROUTINE_SUSPENDED</span>
<span class="w">            </span><span class="c1">// 继续执行</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="m">1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">data1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cont</span><span class="p">.</span><span class="na">result</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Data</span>
<span class="w">            </span><span class="n">cont</span><span class="p">.</span><span class="na">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetchData2</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span><span class="w"> </span><span class="n">cont</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">COROUTINE_SUSPENDED</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">COROUTINE_SUSPENDED</span>
<span class="w">            </span><span class="c1">// 继续执行</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// 其他状态...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_20">五、协程上下文与拦截器<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h2>
<p><code>CoroutineContext</code>使用类似Map的结构存储上下文元素，关键实现：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nc">CoroutineContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">operator</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="o">&lt;</span><span class="n">E</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Element</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">Key</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">):</span><span class="w"> </span><span class="n">E?</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">fold</span><span class="p">(</span><span class="n">initial</span><span class="p">:</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">operation</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">Element</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">R</span><span class="p">):</span><span class="w"> </span><span class="n">R</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">operator</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">plus</span><span class="p">(</span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span><span class="p">):</span><span class="w"> </span><span class="n">CoroutineContext</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nc">Element</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">key</span><span class="p">:</span><span class="w"> </span><span class="n">Key</span><span class="o">&lt;*&gt;</span>
<span class="p">}</span>
</code></pre></div>
<p>拦截器实现：
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nc">ContinuationInterceptor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span><span class="p">.</span><span class="na">Element</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">companion</span><span class="w"> </span><span class="kd">object</span><span class="w"> </span><span class="nc">Key</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span><span class="p">.</span><span class="na">Key</span><span class="o">&lt;</span><span class="n">ContinuationInterceptor</span><span class="o">&gt;</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">interceptContinuation</span><span class="p">(</span><span class="n">continuation</span><span class="p">:</span><span class="w"> </span><span class="n">Continuation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">):</span><span class="w"> </span><span class="n">Continuation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></p>
<h2 id="_21">六、协程取消机制<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h2>
<p>取消通过协作式实现，核心在<code>JobSupport.kt</code>：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">open</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">JobSupport</span><span class="w"> </span><span class="k">constructor</span><span class="p">(</span><span class="n">active</span><span class="p">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Job</span><span class="p">,</span><span class="w"> </span><span class="n">ChildJob</span><span class="p">,</span><span class="w"> </span><span class="n">ParentJob</span><span class="p">,</span><span class="w"> </span><span class="n">SelectClause0</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">cancelImpl</span><span class="p">(</span><span class="n">cause</span><span class="p">:</span><span class="w"> </span><span class="kt">Any?</span><span class="p">):</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 取消逻辑</span>
<span class="w">        </span><span class="n">makeCancelling</span><span class="p">(</span><span class="n">cause</span><span class="p">)</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">makeCancelling</span><span class="p">(</span><span class="n">cause</span><span class="p">:</span><span class="w"> </span><span class="kt">Any?</span><span class="p">):</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 状态转换</span>
<span class="w">        </span><span class="n">_state</span><span class="p">.</span><span class="na">update</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="k">!is</span><span class="w"> </span><span class="n">Incomplete</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c1">// 已经完成</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Finishing</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="p">,</span><span class="w"> </span><span class="n">handled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">            </span><span class="c1">// ...</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// 通知子协程</span>
<span class="w">        </span><span class="n">notifyCancelling</span><span class="p">(</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_22">七、协程与线程池<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h2>
<p>默认调度器使用线程池实现，核心在<code>CoroutineScheduler.kt</code>：</p>
<div class="highlight"><pre><span></span><code><span class="kd">internal</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">CoroutineScheduler</span><span class="p">(</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">corePoolSize</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">idleWorkerKeepAliveNs</span><span class="p">:</span><span class="w"> </span><span class="kt">Long</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IDLE_WORKER_KEEP_ALIVE_NS</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">schedulerName</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_SCHEDULER_NAME</span>
<span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Executor</span><span class="p">,</span><span class="w"> </span><span class="n">Closeable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 工作线程管理</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicArrayOfNulls</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;</span><span class="p">(</span><span class="n">corePoolSize</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 任务队列</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">globalCpuQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GlobalQueue</span><span class="p">()</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">globalBlockingQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GlobalQueue</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 执行逻辑</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="n">Runnable</span><span class="p">,</span><span class="w"> </span><span class="n">taskContext</span><span class="p">:</span><span class="w"> </span><span class="n">TaskContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NonBlockingContext</span><span class="p">,</span><span class="w"> </span><span class="n">tailDispatch</span><span class="p">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 任务分发逻辑</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="flow">八、Flow实现原理<a class="headerlink" href="#flow" title="Permanent link">&para;</a></h2>
<p>Kotlin Flow是基于协程的响应式流实现，核心在<code>Flow.kt</code>：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nc">Flow</span><span class="o">&lt;</span><span class="k">out</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">collect</span><span class="p">(</span><span class="n">collector</span><span class="p">:</span><span class="w"> </span><span class="n">FlowCollector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">flow</span><span class="p">(</span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="n">suspend</span><span class="w"> </span><span class="n">FlowCollector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">.()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="p">):</span><span class="w"> </span><span class="n">Flow</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SafeFlow</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

<span class="kd">private</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">SafeFlow</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">block</span><span class="p">:</span><span class="w"> </span><span class="n">suspend</span><span class="w"> </span><span class="n">FlowCollector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">.()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">AbstractFlow</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">collectSafely</span><span class="p">(</span><span class="n">collector</span><span class="p">:</span><span class="w"> </span><span class="n">FlowCollector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">collector</span><span class="p">.</span><span class="na">block</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_23">九、协程调试支持<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h2>
<p>协程提供了调试工具，通过<code>-Dkotlinx.coroutines.debug</code>启用：</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">actual</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">CoroutineId</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span><span class="p">.</span><span class="na">Key</span><span class="o">&lt;</span><span class="n">CoroutineId</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoroutineId</span><span class="p">.</span><span class="na">Key</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">CoroutineId</span><span class="p">(</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">id</span><span class="p">:</span><span class="w"> </span><span class="kt">Long</span>
<span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ThreadContextElement</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">AbstractCoroutineContextElement</span><span class="p">(</span><span class="n">CoroutineId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 为线程上下文添加协程ID</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_24">总结<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h2>
<p>Kotlin协程通过以下核心技术实现：
1. <strong>CPS转换</strong> - 编译器将挂起函数转换为状态机
2. <strong>续体传递</strong> - 通过Continuation对象管理执行流程
3. <strong>调度器</strong> - 控制协程在哪个线程执行
4. <strong>结构化并发</strong> - 通过Job和Scope管理协程生命周期
5. <strong>协作式取消</strong> - 安全地取消协程执行</p>
<p>协程的轻量级特性来自于它不直接绑定线程，而是通过挂起/恢复机制实现线程的高效利用。</p>
</details>
<h2 id="java">协程和Java线程的关系和区别<a class="headerlink" href="#java" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<p>在协程的实现中（以 <strong>Kotlin协程</strong> 为例），协程的调度依赖于Java线程池或线程模型，但通过封装将协程任务分配到线程上执行。以下是关键类和机制的分析：</p>
<hr />
<h3 id="1-kotlinjava"><strong>1. Kotlin协程中与Java线程交互的核心类</strong><a class="headerlink" href="#1-kotlinjava" title="Permanent link">&para;</a></h3>
<h4 id="1dispatchers"><strong>（1）调度器（Dispatchers）</strong><a class="headerlink" href="#1dispatchers" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>作用</strong>：决定协程运行在哪个线程或线程池。</li>
<li><strong>核心类</strong>：</li>
<li><code>Dispatchers.Default</code>：默认的CPU密集型任务线程池（基于<code>java.util.concurrent.Executor</code>）。</li>
<li><code>Dispatchers.IO</code>：I/O密集型任务的线程池（复用<code>Default</code>的线程池，但允许更大并发数）。</li>
<li><code>Dispatchers.Main</code>：Android/JavaFX等UI线程（通过平台特定实现，如<code>Handler</code>或<code>JavaFX Application Thread</code>）。</li>
</ul>
<p><strong>源码关键点</strong>：
<div class="highlight"><pre><span></span><code><span class="c1">// kotlinx.coroutines.Dispatchers</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">actual</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">Default</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineDispatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DefaultScheduler</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">actual</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">IO</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineDispatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DefaultIoScheduler</span>
</code></pre></div></p>
<h4 id="2java"><strong>（2）线程池实现（底层依赖Java线程）</strong><a class="headerlink" href="#2java" title="Permanent link">&para;</a></h4>
<ul>
<li><strong><code>ExecutorCoroutineDispatcher</code></strong>：<br />
抽象类，将协程调度到Java的<code>Executor</code>线程池。
<div class="highlight"><pre><span></span><code><span class="c1">// kotlinx.coroutines.ExecutorCoroutineDispatcher</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">ExecutorCoroutineDispatcher</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineDispatcher</span><span class="p">(),</span><span class="w"> </span><span class="n">Closeable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">executor</span><span class="p">:</span><span class="w"> </span><span class="n">Executor</span>
<span class="p">}</span>
</code></pre></div></li>
<li><strong><code>ThreadPoolDispatcher</code>（旧版） / <code>DefaultScheduler</code></strong>：<br />
内部使用Java的<code>ThreadPoolExecutor</code>：
<div class="highlight"><pre><span></span><code><span class="c1">// kotlinx.coroutines.scheduling.CoroutineScheduler</span>
<span class="kd">internal</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">CoroutineScheduler</span><span class="p">(...)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Executor</span><span class="p">,</span><span class="w"> </span><span class="n">Closeable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实际使用Java线程池的Worker线程</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">workers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Array</span><span class="p">(</span><span class="n">parallelism</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Worker</span><span class="p">(</span><span class="nb">it</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></li>
</ul>
<h4 id="3coroutinedispatcher"><strong>（3）协程与线程的绑定（CoroutineDispatcher）</strong><a class="headerlink" href="#3coroutinedispatcher" title="Permanent link">&para;</a></h4>
<ul>
<li><strong><code>CoroutineDispatcher</code></strong>：<br />
协程调度器的基类，通过<code>dispatch</code>方法将协程任务分配到线程。
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">CoroutineDispatcher</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="n">Runnable</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></li>
<li>实现类（如<code>Dispatchers.Default</code>）会调用Java线程池的<code>execute</code>方法。</li>
</ul>
<hr />
<h3 id="2_1"><strong>2. 源码调用链示例</strong><a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>以<code>launch(Dispatchers.IO)</code>为例：
1. <strong>启动协程</strong>：
<div class="highlight"><pre><span></span><code><span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* 协程体 */</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
2. <strong>调度到线程池</strong>：
- <code>Dispatchers.IO</code>实际是<code>LimitingDispatcher</code>，最终委托给<code>DefaultScheduler</code>。
- <code>DefaultScheduler</code>内部通过<code>CoroutineScheduler</code>（类似线程池）执行任务。
3. <strong>线程池执行</strong>：
- <code>CoroutineScheduler.Worker</code>继承自<code>Thread</code>，最终由Java线程执行协程任务。</p>
<hr />
<h3 id="3_1"><strong>3. 关键代码片段</strong><a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<h4 id="1java"><strong>（1）调度器使用Java线程池</strong><a class="headerlink" href="#1java" title="Permanent link">&para;</a></h4>
<p>在<code>kotlinx.coroutines.scheduling</code>包中：
<div class="highlight"><pre><span></span><code><span class="c1">// CoroutineScheduler.kt</span>
<span class="kd">internal</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">CoroutineScheduler</span><span class="p">(</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">corePoolSize</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">maxPoolSize</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">idleWorkerKeepAliveNs</span><span class="p">:</span><span class="w"> </span><span class="kt">Long</span>
<span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Executor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Worker是Java线程的封装</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">inner</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">Worker</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="k">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Thread</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runWorker</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<h4 id="2dispatcher"><strong>（2）Dispatcher的线程池绑定</strong><a class="headerlink" href="#2dispatcher" title="Permanent link">&para;</a></h4>
<p><code>Dispatchers.IO</code>的默认实现：
<div class="highlight"><pre><span></span><code><span class="c1">// Dispatchers.kt</span>
<span class="kd">internal</span><span class="w"> </span><span class="kd">object</span><span class="w"> </span><span class="nc">DefaultScheduler</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ExperimentalCoroutineDispatcher</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="n">CoroutineContext</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="n">Runnable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 最终调用CoroutineScheduler的execute方法</span>
<span class="w">        </span><span class="n">coroutineScheduler</span><span class="p">.</span><span class="na">dispatch</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<hr />
<h3 id="4_1"><strong>4. 其他协程库的线程交互</strong><a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<h4 id="1project-loomvirtualthread"><strong>（1）Project Loom（VirtualThread）</strong><a class="headerlink" href="#1project-loomvirtualthread" title="Permanent link">&para;</a></h4>
<ul>
<li><strong><code>VirtualThread</code></strong>：<br />
JVM层面的轻量级线程，直接由JVM调度到Java的<code>Carrier Thread</code>（平台线程）上。
<div class="highlight"><pre><span></span><code><span class="c1">// Java代码示例</span>
<span class="n">Thread</span><span class="p">.</span><span class="na">startVirtualThread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Running on virtual thread&quot;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></li>
</ul>
<h4 id="2quasarqe"><strong>（2）Quasar/QE</strong><a class="headerlink" href="#2quasarqe" title="Permanent link">&para;</a></h4>
<ul>
<li><strong><code>Fiber</code></strong>：<br />
通过字节码增强挂起协程，依赖<code>FiberScheduler</code>（内部使用<code>ForkJoinPool</code>或自定义线程池）。</li>
</ul>
<hr />
<h3 id="_25"><strong>总结</strong><a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>直接依赖Java线程的类</strong>：</li>
<li><code>CoroutineScheduler.Worker</code>（Kotlin协程）</li>
<li><code>ExecutorCoroutineDispatcher</code>（封装Java的<code>Executor</code>）</li>
<li><code>VirtualThread</code>（Project Loom）</li>
<li><strong>核心机制</strong>：</li>
<li>协程通过调度器（<code>Dispatcher</code>）将任务分配到Java线程池。</li>
<li>挂起/恢复由协程库管理，不阻塞底层线程。</li>
</ul>
<p>通过分析<code>Dispatchers</code>、<code>CoroutineScheduler</code>等类，可以清晰看到协程如何利用Java线程实现高效调度。</p>
</details>
<h2 id="kotlin_3">Kotlin协程的并发与同步机制<a class="headerlink" href="#kotlin_3" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<h1 id="kotlin_4">Kotlin协程的并发与同步机制<a class="headerlink" href="#kotlin_4" title="Permanent link">&para;</a></h1>
<p>Kotlin协程提供了强大的并发编程能力，同时也需要合理的同步机制来保证线程安全。下面我将详细解析协程中的并发控制和同步技术。</p>
<h2 id="_26">一、协程并发基础<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h2>
<h3 id="1-vs">1. 并发 vs 并行<a class="headerlink" href="#1-vs" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>并发</strong>：多个任务交替执行，看起来像是同时进行</li>
<li><strong>并行</strong>：多个任务真正同时执行（需要多核CPU支持）</li>
</ul>
<h3 id="2_2">2. 协程并发实现方式<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 方式1：使用多个async并发执行</span>
<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">fetchTwoThings</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">coroutineScope</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">deferred1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fetchData1</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">deferred2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fetchData2</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deferred1</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">result2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">deferred2</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>
<span class="w">        </span><span class="c1">// 处理结果</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 方式2：使用launch并发执行多个任务</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">doMultipleTasks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">Default</span><span class="p">).</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">job1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">task1</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">job2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">task2</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="n">job1</span><span class="p">.</span><span class="na">join</span><span class="p">()</span>
<span class="w">        </span><span class="n">job2</span><span class="p">.</span><span class="na">join</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_27">二、协程同步机制<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h2>
<h3 id="1_2">1. 共享状态问题<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<p>当多个协程访问共享可变状态时会出现竞态条件：</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runBlocking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">repeat</span><span class="p">(</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
<span class="w">            </span><span class="n">counter</span><span class="o">++</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Counter = </span><span class="si">$</span><span class="n">counter</span><span class="s">&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 可能小于100</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2_3">2. 同步解决方案<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h3>
<h4 id="1-mutex">(1) 互斥锁（Mutex）<a class="headerlink" href="#1-mutex" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mutex</span><span class="p">()</span>
<span class="kd">var</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runBlocking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">repeat</span><span class="p">(</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
<span class="w">            </span><span class="n">mutex</span><span class="p">.</span><span class="na">withLock</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">counter</span><span class="o">++</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Counter = </span><span class="si">$</span><span class="n">counter</span><span class="s">&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 保证是100</span>
<span class="p">}</span>
</code></pre></div>
<p>特点：
- 协程挂起而非阻塞
- 不可重入（同一协程不能重复获取锁）
- 比Java的synchronized更轻量</p>
<h4 id="2-atomic">(2) 原子变量（Atomic）<a class="headerlink" href="#2-atomic" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">()</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runBlocking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">repeat</span><span class="p">(</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
<span class="w">            </span><span class="n">counter</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Counter = </span><span class="si">${</span><span class="n">counter</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 保证是100</span>
<span class="p">}</span>
</code></pre></div>
<p>适用场景：
- 简单计数器
- 单一变量的原子操作</p>
<h4 id="3-actor">(3) 单线程限制（Actor模式）<a class="headerlink" href="#3-actor" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">sealed</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">CounterMsg</span>
<span class="kd">object</span><span class="w"> </span><span class="nc">IncCounter</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">CounterMsg</span><span class="p">()</span><span class="w"> </span><span class="c1">// 递增消息</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">GetCounter</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="p">:</span><span class="w"> </span><span class="n">CompletableDeferred</span><span class="o">&lt;</span><span class="kt">Int</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">CounterMsg</span><span class="p">()</span><span class="w"> </span><span class="c1">// 获取值消息</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">counterActor</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">Default</span><span class="p">).</span><span class="na">actor</span><span class="o">&lt;</span><span class="n">CounterMsg</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">IncCounter</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">counter</span><span class="o">++</span>
<span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">GetCounter</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">response</span><span class="p">.</span><span class="na">complete</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counterActor</span><span class="p">()</span>
<span class="w">    </span><span class="n">repeat</span><span class="p">(</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">counter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">IncCounter</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CompletableDeferred</span><span class="o">&lt;</span><span class="kt">Int</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="n">counter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">GetCounter</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Counter = </span><span class="si">${</span><span class="n">response</span><span class="p">.</span><span class="na">await</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">counter</span><span class="p">.</span><span class="na">close</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>特点：
- 所有状态修改都通过消息传递
- 状态被限制在单个协程中访问
- 避免了显式同步</p>
<h4 id="4_2">(4) 协程安全的数据结构<a class="headerlink" href="#4_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">counterContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newSingleThreadContext</span><span class="p">(</span><span class="s">&quot;CounterContext&quot;</span><span class="p">)</span>
<span class="kd">var</span><span class="w"> </span><span class="nv">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runBlocking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">repeat</span><span class="p">(</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">launch</span><span class="p">(</span><span class="n">counterContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 所有修改都在同一线程</span>
<span class="w">            </span><span class="n">counter</span><span class="o">++</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Counter = </span><span class="si">$</span><span class="n">counter</span><span class="s">&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 保证是100</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_28">三、高级并发模式<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h2>
<h3 id="1_3">1. 限制并发数<a class="headerlink" href="#1_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">limitedDispatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">.</span><span class="na">limitedParallelism</span><span class="p">(</span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="c1">// 限制最多4个并发</span>

<span class="kd">fun</span><span class="w"> </span><span class="nf">loadManyItems</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runBlocking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">jobs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">(</span><span class="m">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">async</span><span class="p">(</span><span class="n">limitedDispatcher</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">loadItem</span><span class="p">(</span><span class="nb">it</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">jobs</span><span class="p">.</span><span class="na">awaitAll</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2-barrier">2. 协程同步屏障（Barrier）<a class="headerlink" href="#2-barrier" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">concurrentTasks</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coroutineScope</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">barrier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CyclicBarrier</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>

<span class="w">    </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">        </span><span class="n">task1</span><span class="p">()</span>
<span class="w">        </span><span class="n">barrier</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">        </span><span class="n">task2</span><span class="p">()</span>
<span class="w">        </span><span class="n">barrier</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">        </span><span class="n">task3</span><span class="p">()</span>
<span class="w">        </span><span class="n">barrier</span><span class="p">.</span><span class="na">await</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;All tasks completed&quot;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="3-channel">3. 生产者-消费者模式（Channel）<a class="headerlink" href="#3-channel" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">fun</span><span class="w"> </span><span class="nf">producerConsumer</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runBlocking</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Channel</span><span class="o">&lt;</span><span class="kt">Int</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 生产者</span>
<span class="w">    </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">repeat</span><span class="p">(</span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">channel</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="nb">it</span><span class="p">)</span>
<span class="w">            </span><span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">channel</span><span class="p">.</span><span class="na">close</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 消费者</span>
<span class="w">    </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Received: </span><span class="si">$</span><span class="n">item</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_29">四、最佳实践<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>避免共享可变状态</strong>：优先使用消息传递而非共享状态</li>
<li><strong>最小化同步范围</strong>：只在必要时使用同步机制</li>
<li><strong>选择合适的同步工具</strong>：</li>
<li>简单计数器 → 原子变量</li>
<li>复杂操作 → Mutex</li>
<li>复杂状态 → Actor或单线程限制</li>
<li><strong>注意协程取消</strong>：同步操作应考虑协程取消的情况</li>
<li><strong>性能考量</strong>：</li>
<li>高频操作考虑原子变量</li>
<li>低频复杂操作考虑Mutex</li>
<li>大量并发考虑限制并发数</li>
</ol>
<h2 id="_30">五、常见问题与解决方案<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h2>
<p><strong>问题1</strong>：为什么我的计数器结果不准确？
<strong>解决</strong>：使用Mutex或原子变量保护共享状态</p>
<p><strong>问题2</strong>：协程死锁如何避免？
<strong>解决</strong>：
- 避免在持有锁时调用挂起函数
- 使用tryLock设置超时
- 保持锁的获取顺序一致</p>
<p><strong>问题3</strong>：如何控制资源访问？
<strong>解决</strong>：使用Semaphore
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">semaphore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Semaphore</span><span class="p">(</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="c1">// 允许3个并发访问</span>

<span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">accessResource</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">semaphore</span><span class="p">.</span><span class="na">acquire</span><span class="p">()</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 访问受限资源</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">semaphore</span><span class="p">.</span><span class="na">release</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>Kotlin协程通过提供各种同步原语和并发模式，使得编写并发代码更加简单和安全。理解这些机制并根据具体场景选择合适的方案，可以构建出高效且正确的并发应用程序。</p>
</details>
<h2 id="viewmodelscopelaunch-launch">ViewModelScope.launch{} 这个launch是哪个线程？<a class="headerlink" href="#viewmodelscopelaunch-launch" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<p>在 Kotlin 协程中，<code>viewModelScope.launch {}</code> 启动的协程默认运行在主线程（UI 线程）上。这是因为 <code>viewModelScope</code> 是 <code>ViewModel</code> 的一个扩展属性，它与 <code>Dispatchers.Main</code> 相关联。</p>
<h3 id="_31">为什么是主线程？<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>UI 更新需求</strong>：<code>ViewModel</code> 通常用于管理与 UI 相关的数据，而 UI 更新必须在主线程上进行。因此，<code>viewModelScope</code> 默认使用 <code>Dispatchers.Main</code>，以确保协程中的代码可以直接操作 UI。</p>
</li>
<li>
<p><strong>简化开发</strong>：通过默认使用主线程，开发者无需显式切换线程来处理 UI 更新，减少了代码复杂性。</p>
</li>
</ol>
<h3 id="_32">如何切换线程？<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p>如果你需要在协程中执行耗时操作（如网络请求或数据库查询），可以使用 <code>withContext</code> 切换到其他调度器（如 <code>Dispatchers.IO</code>）：</p>
<div class="highlight"><pre><span></span><code><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 默认在主线程执行</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="na">IO</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 在 IO 线程执行耗时操作</span>
<span class="w">        </span><span class="n">performNetworkRequest</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 回到主线程更新 UI</span>
<span class="w">    </span><span class="n">updateUI</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_33">总结<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<ul>
<li><code>viewModelScope.launch {}</code> 默认在主线程运行，适合 UI 更新。</li>
<li>耗时操作应切换到 <code>Dispatchers.IO</code> 或其他合适的调度器。</li>
<li>使用 <code>withContext</code> 可以方便地在不同线程间切换。</li>
</ul>
</details>
<h2 id="job">协程父子job的取消顺序<a class="headerlink" href="#job" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<h1 id="job_1">协程父子 Job 的取消顺序<a class="headerlink" href="#job_1" title="Permanent link">&para;</a></h1>
<p>在 Kotlin 协程中，父子 Job 的取消遵循特定的顺序规则：</p>
<h2 id="_34">取消传播顺序<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>父 Job 取消时</strong>：</li>
<li>父 Job 取消会自动取消所有子 Job</li>
<li>取消是从父向子传播的（自上而下）</li>
<li>
<p>父 Job 会等待所有子 Job 完成取消后，自己才最终完成取消</p>
</li>
<li>
<p><strong>子 Job 取消时</strong>：</p>
</li>
<li>默认情况下，子 Job 取消不会影响父 Job</li>
<li>但如果子 Job 是因异常而取消，且没有被处理，则异常会传播到父 Job</li>
</ol>
<h2 id="_35">代码示例<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kd">val</span><span class="w"> </span><span class="nv">parentJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">childJob1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">delay</span><span class="p">(</span><span class="kt">Long</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Child 1 cancelled&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 会执行</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">childJob2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Child 2 throws exception&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">()</span><span class="w"> </span><span class="c1">// 会传播到父Job</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">delay</span><span class="p">(</span><span class="m">200</span><span class="p">)</span>
<span class="n">parentJob</span><span class="p">.</span><span class="na">cancel</span><span class="p">()</span><span class="w"> </span><span class="c1">// 会先取消childJob1，然后等待childJob2因异常取消</span>
</code></pre></div>
<h2 id="_36">重要规则<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>结构化并发</strong>原则：父协程总是会等待所有子协程完成</li>
<li><strong>取消是双向的</strong>：虽然子Job取消默认不影响父Job，但通过异常可以实现影响</li>
<li><strong>处理异常</strong>：使用<code>SupervisorJob</code>或<code>supervisorScope</code>可以防止子Job的异常传播到父Job</li>
</ul>
<h2 id="_37">最佳实践<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h2>
<ul>
<li>在子协程的<code>finally</code>块中清理资源</li>
<li>使用<code>NonCancellable</code>上下文执行必须完成的清理操作</li>
<li>对于不想被意外取消的协程，使用<code>SupervisorJob</code></li>
</ul>
</details>
<h2 id="_38"><a class="headerlink" href="#_38" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
</details>
<h2 id="_39"><a class="headerlink" href="#_39" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
</details>
<h2 id="_40"><a class="headerlink" href="#_40" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
</details>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "search.highlight", "content.code.copy", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../js/custom.js"></script>
      
    
  </body>
</html>