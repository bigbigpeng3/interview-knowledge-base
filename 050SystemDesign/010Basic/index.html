
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../041KMP/010Basic/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>系统设计 - 面试知识库</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="面试知识库" class="md-header__button md-logo" aria-label="面试知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            面试知识库
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              系统设计
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换到暗色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换到暗色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换到亮色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换到亮色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../010Java/010Basic/" class="md-tabs__link">
          
  
  Java

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../020Kotlin/010Basic/" class="md-tabs__link">
          
  
  Kotlin

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../030Android/010Basic/" class="md-tabs__link">
          
  
  Android

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../040Jetpack/010Basic/" class="md-tabs__link">
          
  
  Jetpack

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../041KMP/010Basic/" class="md-tabs__link">
          
  
  KMP

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  System Design

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="面试知识库" class="md-nav__button md-logo" aria-label="面试知识库" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    面试知识库
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/040MultiThreading/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java多线程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/020DataStructure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java数据结构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/030Algorithm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java算法
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../010Java/050Pattern/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Java设计模式
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Kotlin
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Kotlin
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../020Kotlin/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotlin基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../020Kotlin/020Coroutines/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotlin协程
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Android
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Android
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../030Android/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../030Android/020SystemSourceCode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android系统源码解析
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../030Android/030ThirdSDKSourceCode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Android三方源码解析
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Jetpack
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Jetpack
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../040Jetpack/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jetpack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../040Jetpack/020Compose/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compose
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    KMP
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            KMP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../041KMP/010Basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kotlin Multi Platform
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    System Design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            System Design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    系统设计
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    系统设计
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#appsdk" class="md-nav__link">
    <span class="md-ellipsis">
      详细讲一下你上一个项目App/SDK的设计思路。
    </span>
  </a>
  
    <nav class="md-nav" aria-label="详细讲一下你上一个项目App/SDK的设计思路。">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      使用到的设计模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdk" class="md-nav__link">
    <span class="md-ellipsis">
      SDK设计思想
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      我所总结的亮点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="我所总结的亮点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      未来优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      如果让你优化上一个项目，你觉得还有哪些方向？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      App, SDK项目中常用的设计模式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android" class="md-nav__link">
    <span class="md-ellipsis">
      设计一个Android平台多线程可断点下载的程序
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#appsdk" class="md-nav__link">
    <span class="md-ellipsis">
      详细讲一下你上一个项目App/SDK的设计思路。
    </span>
  </a>
  
    <nav class="md-nav" aria-label="详细讲一下你上一个项目App/SDK的设计思路。">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      使用到的设计模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sdk" class="md-nav__link">
    <span class="md-ellipsis">
      SDK设计思想
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      我所总结的亮点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="我所总结的亮点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      未来优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      如果让你优化上一个项目，你觉得还有哪些方向？
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      App, SDK项目中常用的设计模式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#android" class="md-nav__link">
    <span class="md-ellipsis">
      设计一个Android平台多线程可断点下载的程序
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="_1">系统设计<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="appsdk">详细讲一下你上一个项目App/SDK的设计思路。<a class="headerlink" href="#appsdk" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>简短答案</summary>
<h3 id="_2">使用到的设计模式<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>外观模式，单例模式，用于SDK的初始化</p>
<p>建造者模式，命令模式，用于API的链式调用</p>
<p>代理模式，用于实现接口，代理一些接口的实现</p>
<p>模板方法模式，用于SDK调用网络时相同流程的封装</p>
<p>适配器模式，用于SDK获取到网络数据后，转换为提供给App使用的Model</p>
<p>观察者模式，用于提供给App的回调使用</p>
<h3 id="sdk">SDK设计思想<a class="headerlink" href="#sdk" title="Permanent link">&para;</a></h3>
<p>稳定
少依赖
单一出口
多模块，适配器
针对SDK的数据收集，比如错误/crash，文件日志</p>
<h3 id="_3">我所总结的亮点<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>api和intern 区分核心业务和API层面，可以针对intern进行混淆加固等处理。</p>
<p>从SDK设计，到链式调用，到实现具体接口，到网络流程的模板，各种设计模式</p>
<p>错误处理
Response 扩展，是整个错误处理的基石。所有的网络错误基本都是这里。包括兜底的错误处理。
Call 扩展，仅仅作为执行和解析的错误抛出
Interceptor自动更新accessToken</p>
<p>自定义Retrofit Converter.Factory() 实现对XML以及JSON的动态解析，不需要额外的成本去实现。</p>
<p>SPIN加密，RSTO加密？配合后台，车辆端进行的加密通信。涉及到有风险的操作都需要SPIN。</p>
<p>使用Kotlin以及协程，避免SDK内部出现内存泄漏。
execute的时候可以让用户自定义协程scope。Processor里面做好判断就行。否则就是默认GlobalScope。</p>
<p>本地日志文件处理</p>
<h4 id="_4">未来优化<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>Android15的代码和老版本的代码合并到同一个分支。
使用Kotlin Multiplatform对项目进行重构。减少新增功能和维护成本。风险中等，时间需要较多。
UI使用Compose重构。可操性大。
自动化jenkins打包。困难来自于公司能否提供支持。</p>
</details>
<details class="answer">
<summary>详细答案</summary>
<p>暂无</p>
</details>
<h2 id="_5">如果让你优化上一个项目，你觉得还有哪些方向？<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
</details>
<h2 id="app-sdk">App, SDK项目中常用的设计模式<a class="headerlink" href="#app-sdk" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<p>以下是Android App和SDK项目中常用的设计模式：</p>
<ol>
<li>
<p>单例模式（Singleton）- 确保一个类只有一个实例，常用于管理系统服务、数据库连接等</p>
</li>
<li>
<p>观察者模式（Observer）- 定义对象间的一对多依赖关系，当一个对象状态改变时，所有依赖它的对象都会收到通知，如LiveData组件</p>
</li>
<li>
<p>工厂模式（Factory Method）- 定义一个创建对象的接口，让子类决定实例化哪个类，常用于创建View、Fragment等</p>
</li>
<li>
<p>建造者模式（Builder）- 用于创建复杂对象，如AlertDialog.Builder、Retrofit.Builder等</p>
</li>
<li>
<p>适配器模式（Adapter）- RecyclerView.Adapter是最典型的例子，将数据集转换为UI组件</p>
</li>
<li>
<p>策略模式（Strategy）- 定义一系列算法，使它们可以互相替换，如不同的动画效果、认证方式等</p>
</li>
<li>
<p>命令模式（Command）- 将请求封装为对象，如Android中的Runnable接口</p>
</li>
<li>
<p>装饰模式（Decorator）- ContextWrapper、ContextThemeWrapper等在Android中的应用</p>
</li>
<li>
<p>MVC/MVP/MVVM架构模式 - 用于分离关注点，提高代码可维护性</p>
</li>
<li>
<p>责任链模式（Chain of Responsibility）- 如Android事件分发机制</p>
</li>
<li>
<p>代理模式（Proxy）- ContentProvider作为数据访问的代理</p>
</li>
<li>
<p>组合模式（Composite）- ViewGroup和View的关系体现了组合模式</p>
</li>
<li>
<p>模板方法模式（Template Method）- Activity生命周期方法如onCreate()、onResume()等</p>
</li>
<li>
<p>享元模式（Flyweight）- 系统资源池如线程池、连接池等</p>
</li>
</ol>
<p>这些设计模式帮助开发者构建更加模块化、可扩展和易于维护的Android应用程序和SDK。</p>
<p>公司项目SDK使用的是单例，桥接模式API分层设计，策略模式多个不同的JV登录方式， </p>
</details>
<h2 id="android">设计一个Android平台多线程可断点下载的程序<a class="headerlink" href="#android" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<h1 id="android_1">Android 多线程可断点下载方案<a class="headerlink" href="#android_1" title="Permanent link">&para;</a></h1>
<h2 id="_6">一、整体架构设计<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="1">1. 三层架构<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>表示层</strong>：Activity/Fragment 用于展示下载进度和提供用户交互</li>
<li><strong>业务层</strong>：DownloadManager 管理下载任务和线程</li>
<li><strong>数据层</strong>：本地数据库存储下载信息和断点信息</li>
</ul>
<h3 id="2">2. 核心组件<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>DownloadService</strong>：前台服务，负责执行下载任务</li>
<li><strong>DownloadTask</strong>：下载任务对象，包含文件信息和状态</li>
<li><strong>DownloadThread</strong>：下载线程，负责文件分块下载</li>
<li><strong>DownloadDatabase</strong>：存储下载历史和断点信息</li>
<li><strong>DownloadNotification</strong>：前台通知，显示下载进度</li>
</ul>
<h2 id="_7">二、文件处理详细方案<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="1-randomaccessfile">1. RandomAccessFile 的使用<a class="headerlink" href="#1-randomaccessfile" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 初始化文件</span>
<span class="n">RandomAccessFile</span><span class="w"> </span><span class="n">raf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RandomAccessFile</span><span class="p">(</span><span class="n">saveFile</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;rw&quot;</span><span class="p">);</span>
<span class="c1">// 预分配文件大小</span>
<span class="n">raf</span><span class="p">.</span><span class="na">setLength</span><span class="p">(</span><span class="n">contentLength</span><span class="p">);</span>
<span class="c1">// 关闭资源</span>
<span class="n">raf</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>

<span class="c1">// 线程中写入数据</span>
<span class="n">RandomAccessFile</span><span class="w"> </span><span class="n">threadRaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RandomAccessFile</span><span class="p">(</span><span class="n">saveFile</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;rw&quot;</span><span class="p">);</span>
<span class="c1">// 定位到下载块的起始位置</span>
<span class="n">threadRaf</span><span class="p">.</span><span class="na">seek</span><span class="p">(</span><span class="n">downloadPart</span><span class="p">.</span><span class="na">currentPos</span><span class="p">);</span>
<span class="c1">// 写入数据</span>
<span class="n">threadRaf</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="c1">// 关闭时不要立即关闭，等到块下载完成或暂停时关闭</span>
</code></pre></div>
<h3 id="2_1">2. 文件锁与线程安全<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<ul>
<li>使用 <code>FileChannel</code> 和 <code>FileLock</code> 确保多线程写入安全</li>
<li>每个线程锁定自己的文件区域进行写入</li>
<li>使用 <code>synchronized</code> 块保护共享资源访问</li>
</ul>
<h3 id="3">3. 文件存储位置选择<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<ul>
<li>Android 10+ 适配分区存储</li>
<li>小文件存储在内部存储 <code>context.getFilesDir()</code></li>
<li>大文件和媒体文件存储在外部存储 <code>Environment.getExternalStoragePublicDirectory()</code></li>
<li>使用 <code>MediaStore</code> API 处理分区存储限制</li>
</ul>
<h2 id="_8">三、下载任务数据模型<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<h3 id="1_1">1. 下载任务模型<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DownloadTask</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">;</span><span class="w">                </span><span class="c1">// 下载地址</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">filePath</span><span class="p">;</span><span class="w">           </span><span class="c1">// 保存路径</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">fileName</span><span class="p">;</span><span class="w">           </span><span class="c1">// 文件名</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">fileSize</span><span class="p">;</span><span class="w">             </span><span class="c1">// 文件总大小</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">downloadedSize</span><span class="p">;</span><span class="w">       </span><span class="c1">// 已下载大小</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">threadCount</span><span class="p">;</span><span class="w">           </span><span class="c1">// 线程数量</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w">                </span><span class="c1">// 任务状态</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">lastModified</span><span class="p">;</span><span class="w">         </span><span class="c1">// 文件最后修改时间</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">etag</span><span class="p">;</span><span class="w">               </span><span class="c1">// HTTP ETag</span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">DownloadPart</span><span class="o">&gt;</span><span class="w"> </span><span class="n">parts</span><span class="p">;</span><span class="w">  </span><span class="c1">// 分块信息</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2_2">2. 下载分块模型<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DownloadPart</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">                   </span><span class="c1">// 分块ID</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">taskId</span><span class="p">;</span><span class="w">               </span><span class="c1">// 所属任务ID</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">threadId</span><span class="p">;</span><span class="w">              </span><span class="c1">// 线程ID</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">startPos</span><span class="p">;</span><span class="w">             </span><span class="c1">// 起始位置</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">endPos</span><span class="p">;</span><span class="w">               </span><span class="c1">// 结束位置</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">currentPos</span><span class="p">;</span><span class="w">           </span><span class="c1">// 当前位置</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span><span class="w">                </span><span class="c1">// 状态</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">retryCount</span><span class="p">;</span><span class="w">            </span><span class="c1">// 重试次数</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_9">四、多线程管理机制<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<h3 id="1_2">1. 线程池配置<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">threadPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span>
<span class="w">    </span><span class="mi">3</span><span class="p">,</span><span class="w">                              </span><span class="c1">// 核心线程数</span>
<span class="w">    </span><span class="mi">5</span><span class="p">,</span><span class="w">                              </span><span class="c1">// 最大线程数</span>
<span class="w">    </span><span class="mi">60L</span><span class="p">,</span><span class="w">                            </span><span class="c1">// 空闲线程存活时间</span>
<span class="w">    </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span><span class="w">               </span><span class="c1">// 时间单位</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">(),</span><span class="w">    </span><span class="c1">// 工作队列</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">.</span><span class="na">CallerRunsPolicy</span><span class="p">()</span><span class="w">  </span><span class="c1">// 拒绝策略</span>
<span class="p">);</span>
</code></pre></div>
<h3 id="2_3">2. 线程数量动态调整<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h3>
<ul>
<li>根据网络类型调整（WiFi 可用更多线程）</li>
<li>根据文件大小调整（大文件分配更多线程）</li>
<li>根据设备性能调整（高性能设备分配更多线程）</li>
</ul>
<h3 id="3_1">3. 线程状态监控<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<ul>
<li>维护线程状态集合</li>
<li>定期检查僵死线程并重启</li>
<li>实现线程进度回调机制</li>
</ul>
<h2 id="_10">五、断点续传详细实现<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<h3 id="1-http">1. HTTP 请求头处理<a class="headerlink" href="#1-http" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 添加 Range 请求头</span>
<span class="n">connection</span><span class="p">.</span><span class="na">setRequestProperty</span><span class="p">(</span><span class="s">&quot;Range&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bytes=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">part</span><span class="p">.</span><span class="na">currentPos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">part</span><span class="p">.</span><span class="na">endPos</span><span class="p">);</span>

<span class="c1">// 添加 If-Match 和 If-Modified-Since 头，防止文件变更</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">etag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">connection</span><span class="p">.</span><span class="na">setRequestProperty</span><span class="p">(</span><span class="s">&quot;If-Match&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="na">etag</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">lastModified</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">connection</span><span class="p">.</span><span class="na">setRequestProperty</span><span class="p">(</span><span class="s">&quot;If-Modified-Since&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="na">lastModified</span><span class="p">).</span><span class="na">toGMTString</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2_4">2. 断点信息持久化<a class="headerlink" href="#2_4" title="Permanent link">&para;</a></h3>
<ul>
<li>使用 Room 数据库存储</li>
<li>创建 DAO 接口处理数据操作</li>
<li>使用事务确保数据一致性</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nd">@Database</span><span class="p">(</span><span class="n">entities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">DownloadTask</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">DownloadPart</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DownloadDatabase</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">RoomDatabase</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">DownloadTaskDao</span><span class="w"> </span><span class="nf">taskDao</span><span class="p">();</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">DownloadPartDao</span><span class="w"> </span><span class="nf">partDao</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="3_2">3. 进度更新策略<a class="headerlink" href="#3_2" title="Permanent link">&para;</a></h3>
<ul>
<li>使用 <code>AtomicLong</code> 记录已下载大小</li>
<li>批量更新减少数据库操作</li>
<li>采用增量更新而非全量更新</li>
</ul>
<h2 id="_11">六、网络处理<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<h3 id="1_3">1. 网络请求实现<a class="headerlink" href="#1_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="n">HttpURLConnection</span><span class="w"> </span><span class="nf">createConnection</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">DownloadPart</span><span class="w"> </span><span class="n">part</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">HttpURLConnection</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HttpURLConnection</span><span class="p">)</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="na">openConnection</span><span class="p">();</span>
<span class="w">    </span><span class="n">connection</span><span class="p">.</span><span class="na">setRequestMethod</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">connection</span><span class="p">.</span><span class="na">setReadTimeout</span><span class="p">(</span><span class="mi">30000</span><span class="p">);</span>
<span class="w">    </span><span class="n">connection</span><span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="mi">15000</span><span class="p">);</span>
<span class="w">    </span><span class="n">connection</span><span class="p">.</span><span class="na">setRequestProperty</span><span class="p">(</span><span class="s">&quot;Accept-Encoding&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">connection</span><span class="p">.</span><span class="na">setRequestProperty</span><span class="p">(</span><span class="s">&quot;Range&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;bytes=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">part</span><span class="p">.</span><span class="na">currentPos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">part</span><span class="p">.</span><span class="na">endPos</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">connection</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2_5">2. 网络监听与自动调整<a class="headerlink" href="#2_5" title="Permanent link">&para;</a></h3>
<ul>
<li>注册 <code>ConnectivityManager.NetworkCallback</code> 监听网络变化</li>
<li>实现网络切换时的自动暂停/恢复</li>
<li>根据网络类型调整下载速度和线程数</li>
</ul>
<h3 id="3_3">3. 网络异常处理策略<a class="headerlink" href="#3_3" title="Permanent link">&para;</a></h3>
<ul>
<li>HTTP 状态码处理（支持 206 状态码）</li>
<li>实现指数退避算法进行重试</li>
<li>处理特殊情况（服务器不支持 Range 请求）</li>
</ul>
<h2 id="service">七、Service 与生命周期管理<a class="headerlink" href="#service" title="Permanent link">&para;</a></h2>
<h3 id="1_4">1. 前台服务实现<a class="headerlink" href="#1_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startForeground</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">NotificationCompat</span><span class="p">.</span><span class="na">Builder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NotificationCompat</span><span class="p">.</span><span class="na">Builder</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">CHANNEL_ID</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">setSmallIcon</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">drawable</span><span class="p">.</span><span class="na">ic_download</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">setContentTitle</span><span class="p">(</span><span class="s">&quot;下载管理器&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">setContentText</span><span class="p">(</span><span class="s">&quot;正在下载...&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">setPriority</span><span class="p">(</span><span class="n">NotificationCompat</span><span class="p">.</span><span class="na">PRIORITY_LOW</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">setProgress</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 添加操作按钮</span>
<span class="w">    </span><span class="n">Intent</span><span class="w"> </span><span class="n">pauseIntent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Intent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">DownloadService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">    </span><span class="n">pauseIntent</span><span class="p">.</span><span class="na">setAction</span><span class="p">(</span><span class="n">ACTION_PAUSE_ALL</span><span class="p">);</span>
<span class="w">    </span><span class="n">PendingIntent</span><span class="w"> </span><span class="n">pausePendingIntent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PendingIntent</span><span class="p">.</span><span class="na">getService</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">pauseIntent</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">PendingIntent</span><span class="p">.</span><span class="na">FLAG_UPDATE_CURRENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PendingIntent</span><span class="p">.</span><span class="na">FLAG_IMMUTABLE</span><span class="p">);</span>
<span class="w">    </span><span class="n">builder</span><span class="p">.</span><span class="na">addAction</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">drawable</span><span class="p">.</span><span class="na">ic_pause</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;暂停全部&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pausePendingIntent</span><span class="p">);</span>

<span class="w">    </span><span class="n">startForeground</span><span class="p">(</span><span class="n">NOTIFICATION_ID</span><span class="p">,</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2_6">2. 进程保活策略<a class="headerlink" href="#2_6" title="Permanent link">&para;</a></h3>
<ul>
<li>使用 <code>START_STICKY</code> 返回值</li>
<li>实现低内存重建机制</li>
<li>使用 <code>WorkManager</code> 作为备选重启机制</li>
</ul>
<h3 id="3-android">3. Android 版本适配<a class="headerlink" href="#3-android" title="Permanent link">&para;</a></h3>
<ul>
<li>Android 8.0+ 前台服务通知渠道</li>
<li>Android 10+ 分区存储适配</li>
<li>Android 12+ 精确闹钟权限</li>
</ul>
<h2 id="_12">八、用户界面交互<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<h3 id="1_5">1. 进度回调接口<a class="headerlink" href="#1_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">DownloadListener</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onProgressUpdate</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">downloaded</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">total</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onStatusChanged</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onError</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">errorCode</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">errorMessage</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onComplete</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2_7">2. 通知更新机制<a class="headerlink" href="#2_7" title="Permanent link">&para;</a></h3>
<ul>
<li>使用节流技术限制通知更新频率</li>
<li>支持下载速度显示</li>
<li>实现可扩展通知显示详细进度</li>
</ul>
<h3 id="3_4">3. 用户控制功能<a class="headerlink" href="#3_4" title="Permanent link">&para;</a></h3>
<ul>
<li>暂停/继续单个任务</li>
<li>暂停/继续全部任务</li>
<li>取消任务并删除文件</li>
<li>仅取消任务保留文件</li>
</ul>
<h2 id="_13">九、性能优化<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<h3 id="1_6">1. 缓冲区优化<a class="headerlink" href="#1_6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 使用缓冲区减少IO次数</span>
<span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="c1">// 8KB 缓冲区</span>
<span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">randomFile</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="n">downloadedSize</span><span class="p">.</span><span class="na">addAndGet</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="w">    </span><span class="n">part</span><span class="p">.</span><span class="na">currentPos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 检查暂停/取消信号</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldStop</span><span class="p">())</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="2_8">2. 内存使用优化<a class="headerlink" href="#2_8" title="Permanent link">&para;</a></h3>
<ul>
<li>避免在循环中创建对象</li>
<li>使用软引用缓存下载信息</li>
<li>及时关闭资源防止泄漏</li>
</ul>
<h3 id="3_5">3. 电池优化<a class="headerlink" href="#3_5" title="Permanent link">&para;</a></h3>
<ul>
<li>监听电池状态调整下载策略</li>
<li>支持低电量自动暂停</li>
<li>仅在充电时下载大文件</li>
</ul>
<h2 id="_14">十、异常处理与恢复<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h2>
<h3 id="1_7">1. 下载异常分类<a class="headerlink" href="#1_7" title="Permanent link">&para;</a></h3>
<ul>
<li>网络异常（连接超时、服务器错误）</li>
<li>文件异常（存储空间不足、权限问题）</li>
<li>线程异常（中断、执行异常）</li>
</ul>
<h3 id="2_9">2. 异常恢复机制<a class="headerlink" href="#2_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleException</span><span class="p">(</span><span class="n">DownloadPart</span><span class="w"> </span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">SocketTimeoutException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 超时重试</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">part</span><span class="p">.</span><span class="na">retryCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MAX_RETRY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">part</span><span class="p">.</span><span class="na">retryCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="n">part</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STATUS_WAITING</span><span class="p">;</span>
<span class="w">            </span><span class="n">partDao</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// 延迟后重新加入队列</span>
<span class="w">            </span><span class="n">scheduleRetry</span><span class="p">(</span><span class="n">part</span><span class="p">,</span><span class="w"> </span><span class="n">getRetryDelay</span><span class="p">(</span><span class="n">part</span><span class="p">.</span><span class="na">retryCount</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 超过最大重试次数</span>
<span class="w">            </span><span class="n">part</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STATUS_ERROR</span><span class="p">;</span>
<span class="w">            </span><span class="n">partDao</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
<span class="w">            </span><span class="n">notifyError</span><span class="p">(</span><span class="n">part</span><span class="p">.</span><span class="na">taskId</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR_TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;下载超时&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">IOException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 处理IO异常</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="3_6">3. 文件完整性验证<a class="headerlink" href="#3_6" title="Permanent link">&para;</a></h3>
<ul>
<li>下载完成后验证文件大小</li>
<li>支持MD5/SHA校验（如果服务器提供校验和）</li>
<li>支持损坏文件修复（重新下载损坏部分）</li>
</ul>
<h2 id="_15">十一、安全与权限<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h2>
<h3 id="1-https">1. HTTPS 支持<a class="headerlink" href="#1-https" title="Permanent link">&para;</a></h3>
<ul>
<li>支持 SSL/TLS 连接</li>
<li>处理证书验证问题</li>
<li>支持自签名证书（可选）</li>
</ul>
<h3 id="2_10">2. 权限处理<a class="headerlink" href="#2_10" title="Permanent link">&para;</a></h3>
<ul>
<li>动态申请存储权限</li>
<li>处理权限拒绝场景</li>
<li>适配 Android 13+ 细分文件权限</li>
</ul>
<h3 id="3_7">3. 下载文件扫描<a class="headerlink" href="#3_7" title="Permanent link">&para;</a></h3>
<ul>
<li>下载完成后进行病毒扫描</li>
<li>集成系统 MediaScanner 更新媒体库</li>
<li>支持文件类型识别和过滤</li>
</ul>
<p>这份详细方案涵盖了Android多线程断点下载的所有核心环节和技术细节，既考虑了功能完整性，也兼顾了性能优化和用户体验。方案中的代码片段可以直接作为实现参考，帮助开发者快速构建一个健壮的下载系统。</p>
</details>
<h2 id="androidsdk">设计一个Android平台上传日志的SDK<a class="headerlink" href="#androidsdk" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<h1 id="android-sdk">Android 日志上传 SDK 设计<a class="headerlink" href="#android-sdk" title="Permanent link">&para;</a></h1>
<h2 id="_16">概述<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h2>
<p>这个 SDK 将使 Android 应用程序能够收集、缓存和上传日志到远程服务器。设计重点关注效率、可靠性以及最小化电池和网络影响。</p>
<h2 id="_17">核心组件<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h2>
<h3 id="1_8">1. 日志收集器<a class="headerlink" href="#1_8" title="Permanent link">&para;</a></h3>
<ul>
<li>捕获各种日志类型（应用事件、崩溃、性能指标、用户交互）</li>
<li>提供不同的日志级别（DEBUG、INFO、WARNING、ERROR、FATAL）</li>
<li>维护上下文信息（设备信息、应用版本、用户会话）</li>
</ul>
<h3 id="2_11">2. 存储管理器<a class="headerlink" href="#2_11" title="Permanent link">&para;</a></h3>
<ul>
<li>实现日志的本地持久化存储</li>
<li>处理日志轮换和大小限制</li>
<li>加密敏感日志数据</li>
<li>管理存储配额，防止过度占用磁盘空间</li>
</ul>
<h3 id="3_8">3. 上传服务<a class="headerlink" href="#3_8" title="Permanent link">&para;</a></h3>
<ul>
<li>根据网络状态和策略触发上传</li>
<li>支持批量上传以减少网络请求</li>
<li>实现重试机制和失败处理</li>
<li>提供上传进度和状态回调</li>
</ul>
<h3 id="4">4. 配置管理器<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<ul>
<li>允许开发者自定义日志行为（采样率、上传频率）</li>
<li>支持远程配置更新</li>
<li>管理日志过滤规则</li>
</ul>
<h3 id="5">5. 策略引擎<a class="headerlink" href="#5" title="Permanent link">&para;</a></h3>
<ul>
<li>基于电池状态、网络类型和用量决定上传时机</li>
<li>支持智能批处理和压缩</li>
<li>提供优先级机制（如立即上传崩溃日志）</li>
</ul>
<h2 id="_18">架构设计<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h2>
<h3 id="api">API 层<a class="headerlink" href="#api" title="Permanent link">&para;</a></h3>
<ul>
<li>简洁的开发者接口</li>
<li>灵活的日志分类和标记</li>
<li>支持链式调用和上下文注入</li>
</ul>
<h3 id="_19">处理层<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<ul>
<li>异步处理以避免阻塞主线程</li>
<li>线程池管理</li>
<li>事件驱动架构</li>
</ul>
<h3 id="_20">存储层<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<ul>
<li>支持 SQLite 和文件系统存储</li>
<li>缓存机制</li>
<li>数据压缩</li>
</ul>
<h3 id="_21">网络层<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<ul>
<li>HTTP/HTTPS 传输</li>
<li>支持断点续传</li>
<li>适应性网络请求（根据网络条件调整请求大小）</li>
</ul>
<h2 id="_22">隐私与安全考虑<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h2>
<ul>
<li>用户数据脱敏处理</li>
<li>传输和存储加密</li>
<li>遵循 GDPR 和其他隐私法规</li>
<li>提供日志数据留存策略</li>
</ul>
<h2 id="_23">性能优化<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h2>
<ul>
<li>最小化内存和电池影响</li>
<li>智能调度上传任务</li>
<li>自适应批处理大小</li>
<li>压缩算法选择</li>
</ul>
<h2 id="_24">集成流程<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h2>
<ol>
<li>通过 Gradle 或 Maven 添加依赖</li>
<li>在应用初始化时配置 SDK</li>
<li>定义日志上传端点和认证信息</li>
<li>在代码中使用日志 API</li>
</ol>
<h2 id="_25">扩展性<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h2>
<ul>
<li>插件系统支持自定义日志处理器</li>
<li>适配器模式支持不同的后端服务</li>
<li>观察者模式实现事件响应</li>
</ul>
<p>这个设计提供了一个全面的框架，可以根据具体需求进一步细化和实现。</p>
<h1 id="sdk_1">SDK远程控制日志上传机制设计<a class="headerlink" href="#sdk_1" title="Permanent link">&para;</a></h1>
<h2 id="_26">远程触发日志上传功能<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h2>
<p>为了支持后台控制SDK上传日志的需求，特别是当用户上报问题需要服务器主动获取客户端日志时，可以设计以下机制：</p>
<h3 id="1_9">1. 推送通知机制<a class="headerlink" href="#1_9" title="Permanent link">&para;</a></h3>
<ul>
<li>集成推送服务（如Firebase Cloud Messaging或华为推送服务）</li>
<li>服务器可发送特定格式的推送消息，触发日志上传</li>
<li>SDK需包含推送消息接收器，识别并处理日志上传指令</li>
</ul>
<h3 id="2_12">2. 轮询机制<a class="headerlink" href="#2_12" title="Permanent link">&para;</a></h3>
<ul>
<li>SDK定期请求后台服务器检查是否需要上传日志</li>
<li>可配置轮询间隔和条件（如仅在WiFi环境下轮询）</li>
<li>服务器返回上传指令，包含需要上传的日志类型、时间范围等参数</li>
</ul>
<h3 id="3-websocket">3. WebSocket长连接<a class="headerlink" href="#3-websocket" title="Permanent link">&para;</a></h3>
<ul>
<li>维护与服务器的WebSocket连接</li>
<li>实时接收服务器发送的日志上传指令</li>
<li>适用于需要频繁与服务器通信的应用场景</li>
</ul>
<h3 id="4_1">4. 远程配置中心<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<ul>
<li>接入配置中心服务（如Firebase Remote Config）</li>
<li>通过修改远程配置触发特定用户或设备的日志上传</li>
<li>SDK定期同步配置并执行相应操作</li>
</ul>
<h2 id="_27">实现细节<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h2>
<h3 id="_28">控制指令格式设计<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>{
&quot;command&quot;: &quot;upload_logs&quot;,
&quot;requestId&quot;: &quot;unique-request-id&quot;,
&quot;logTypes&quot;: [&quot;crash&quot;, &quot;performance&quot;, &quot;user_action&quot;],
&quot;timeRange&quot;: {
    &quot;start&quot;: &quot;2025-03-20T00:00:00Z&quot;,
    &quot;end&quot;: &quot;2025-03-24T00:00:00Z&quot;
},
&quot;priority&quot;: &quot;high&quot;,
&quot;uploadEndpoint&quot;: &quot;https://logs.example.com/special-upload&quot;
}
</code></pre></div>
<h3 id="_29">日志筛选机制<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<ul>
<li>支持按时间范围筛选</li>
<li>支持按日志级别筛选</li>
<li>支持按日志标签或模块筛选</li>
<li>支持按用户会话筛选</li>
</ul>
<h3 id="_30">权限与安全<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<ul>
<li>远程触发机制需要严格的认证</li>
<li>对控制指令进行签名验证，防止伪造</li>
<li>限制上传频率，避免滥用</li>
<li>确保用户隐私符合相关法规</li>
</ul>
<h3 id="_31">用户体验考虑<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<ul>
<li>可选的用户授权机制（如提示用户确认上传）</li>
<li>仅在适当条件下执行（如连接WiFi、设备闲置时）</li>
<li>上传过程中显示通知，保持透明度</li>
<li>限制上传大小和时长，避免影响用户体验</li>
</ul>
<h3 id="_32">实现流程<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<ol>
<li>服务器识别需要获取日志的设备</li>
<li>通过推送或配置中心发送指令</li>
<li>SDK接收并验证指令</li>
<li>根据指令参数筛选本地日志</li>
<li>执行上传并发送结果报告</li>
<li>服务器确认接收完成</li>
</ol>
<h2 id="_33">技术挑战与解决方案<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h2>
<h3 id="_34">离线设备处理<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<ul>
<li>将上传指令持久化存储</li>
<li>设备上线后立即检查并执行待处理的指令</li>
<li>设置指令过期时间，避免执行过时的上传请求</li>
</ul>
<h3 id="_35">大量日志处理<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h3>
<ul>
<li>分批上传机制</li>
<li>增量上传支持</li>
<li>对大型日志文件进行压缩</li>
</ul>
<h3 id="_36">网络不稳定情况<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<ul>
<li>断点续传</li>
<li>自动重试机制</li>
<li>网络切换时保持上传状态</li>
</ul>
<p>这种设计能够满足开发者在用户报告问题后主动获取客户端日志的需求，同时兼顾了用户体验、隐私安全和网络效率。</p>
</details>
<h2 id="android-appokhttp-retrofit">Android App的网络框架要如何设计，更方便开发人员调用？使用Okhttp Retrofit。<a class="headerlink" href="#android-appokhttp-retrofit" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<p>我可以为你提供一个基于OkHttp和Retrofit的Android网络框架设计，使其更便于开发人员调用。</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm">* Android网络框架设计 - 基于OkHttp和Retrofit</span>
<span class="cm">* 目标：设计一个易用、可扩展的网络层</span>
<span class="cm">*/</span>

<span class="c1">// 1. 网络配置管理器 - 管理OkHttp实例和通用配置</span>
<span class="kd">object</span><span class="w"> </span><span class="nc">NetworkManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">TIMEOUT_CONNECT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15L</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">TIMEOUT_READ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15L</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">TIMEOUT_WRITE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15L</span>

<span class="w">    </span><span class="c1">// 基础URL</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">BASE_URL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;https://api.example.com/&quot;</span>

<span class="w">    </span><span class="c1">// 创建OkHttpClient</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">okHttpClient</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">lazy</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">OkHttpClient</span><span class="p">.</span><span class="na">Builder</span><span class="p">().</span><span class="na">apply</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 设置超时时间</span>
<span class="w">            </span><span class="n">connectTimeout</span><span class="p">(</span><span class="n">TIMEOUT_CONNECT</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">)</span>
<span class="w">            </span><span class="n">readTimeout</span><span class="p">(</span><span class="n">TIMEOUT_READ</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">)</span>
<span class="w">            </span><span class="n">writeTimeout</span><span class="p">(</span><span class="n">TIMEOUT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">)</span>

<span class="w">            </span><span class="c1">// 添加通用拦截器</span>
<span class="w">            </span><span class="n">addInterceptor</span><span class="p">(</span><span class="n">HeaderInterceptor</span><span class="p">())</span>
<span class="w">            </span><span class="n">addInterceptor</span><span class="p">(</span><span class="n">LoggingInterceptor</span><span class="p">())</span>

<span class="w">            </span><span class="c1">// 错误处理拦截器</span>
<span class="w">            </span><span class="n">addInterceptor</span><span class="p">(</span><span class="n">ErrorInterceptor</span><span class="p">())</span>

<span class="w">            </span><span class="c1">// 缓存策略</span>
<span class="w">            </span><span class="n">cache</span><span class="p">(</span><span class="n">Cache</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="s">&quot;缓存目录路径&quot;</span><span class="p">),</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1024</span><span class="p">))</span><span class="w"> </span><span class="c1">// 10MB缓存</span>

<span class="w">            </span><span class="c1">// 重试策略</span>
<span class="w">            </span><span class="n">retryOnConnectionFailure</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">}.</span><span class="na">build</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 创建Retrofit实例</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">retrofit</span><span class="p">:</span><span class="w"> </span><span class="n">Retrofit</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">lazy</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Retrofit</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">baseUrl</span><span class="p">(</span><span class="n">BASE_URL</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">client</span><span class="p">(</span><span class="n">okHttpClient</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">addConverterFactory</span><span class="p">(</span><span class="n">GsonConverterFactory</span><span class="p">.</span><span class="na">create</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">addCallAdapterFactory</span><span class="p">(</span><span class="n">CoroutineCallAdapterFactory</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 创建API服务的简便方法</span>
<span class="w">    </span><span class="kd">inline</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="o">&lt;</span><span class="k">reified</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createApiService</span><span class="p">():</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retrofit</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 2. 拦截器</span>
<span class="c1">// 添加通用头部信息</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">HeaderInterceptor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Interceptor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span><span class="w"> </span><span class="n">Interceptor</span><span class="p">.</span><span class="na">Chain</span><span class="p">):</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">().</span><span class="na">newBuilder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">addHeader</span><span class="p">(</span><span class="s">&quot;Content-Type&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;application/json&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">addHeader</span><span class="p">(</span><span class="s">&quot;Accept&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;application/json&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">addHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">TokenManager</span><span class="p">.</span><span class="na">getToken</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">addHeader</span><span class="p">(</span><span class="s">&quot;User-Agent&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Android Client&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 记录网络请求日志</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">LoggingInterceptor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Interceptor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span><span class="w"> </span><span class="n">Interceptor</span><span class="p">.</span><span class="na">Chain</span><span class="p">):</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span>

<span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&quot;API&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;发送请求: </span><span class="si">${</span><span class="n">request</span><span class="p">.</span><span class="na">url</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">endTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span>
<span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&quot;API&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;收到响应: </span><span class="si">${</span><span class="n">response</span><span class="p">.</span><span class="na">code</span><span class="si">}</span><span class="s"> (</span><span class="si">${</span><span class="n">endTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">startTime</span><span class="si">}</span><span class="s">ms)&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">response</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 错误处理拦截器</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">ErrorInterceptor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Interceptor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span><span class="w"> </span><span class="n">Interceptor</span><span class="p">.</span><span class="na">Chain</span><span class="p">):</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">()</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="m">401</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">EventBus</span><span class="p">.</span><span class="na">getDefault</span><span class="p">().</span><span class="na">post</span><span class="p">(</span><span class="n">UnauthorizedEvent</span><span class="p">())</span>
<span class="w">            </span><span class="m">500</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Log</span><span class="p">.</span><span class="na">e</span><span class="p">(</span><span class="s">&quot;API&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;服务器错误: </span><span class="si">${</span><span class="n">response</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="c1">// 处理其他状态码...</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">response</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 3. API接口定义示例</span>
<span class="kd">interface</span><span class="w"> </span><span class="nc">ApiService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@GET</span><span class="p">(</span><span class="s">&quot;users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getUsers</span><span class="p">():</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span>

<span class="w">    </span><span class="nd">@GET</span><span class="p">(</span><span class="s">&quot;users/{userId}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getUserById</span><span class="p">(</span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">userId</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">):</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span>

<span class="w">    </span><span class="nd">@POST</span><span class="p">(</span><span class="s">&quot;users&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">createUser</span><span class="p">(</span><span class="nd">@Body</span><span class="w"> </span><span class="n">user</span><span class="p">:</span><span class="w"> </span><span class="n">User</span><span class="p">):</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="c1">// 4. 响应包装类</span>
<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">ApiResponse</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">data</span><span class="p">:</span><span class="w"> </span><span class="n">T?,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">errorCode</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">errorMsg</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">success</span><span class="p">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="p">)</span>

<span class="c1">// 5. 资源封装类 - 方便处理不同状态</span>
<span class="kd">sealed</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">Resource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">class</span><span class="w"> </span><span class="nc">Success</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">data</span><span class="p">:</span><span class="w"> </span><span class="n">T</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="kd">class</span><span class="w"> </span><span class="nc">Error</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">message</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">data</span><span class="p">:</span><span class="w"> </span><span class="n">T? </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="kd">class</span><span class="w"> </span><span class="nc">Loading</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// 6. 仓库层 - 处理数据获取逻辑</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">UserRepository</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">apiService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NetworkManager</span><span class="p">.</span><span class="na">createApiService</span><span class="o">&lt;</span><span class="n">ApiService</span><span class="o">&gt;</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 使用协程获取数据并处理结果</span>
<span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getUsers</span><span class="p">():</span><span class="w"> </span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apiService</span><span class="p">.</span><span class="na">getUsers</span><span class="p">()</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">isSuccessful</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Resource</span><span class="p">.</span><span class="na">Success</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">()</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="n">emptyList</span><span class="p">())</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">Resource</span><span class="p">.</span><span class="na">Error</span><span class="p">(</span><span class="s">&quot;Error </span><span class="si">${</span><span class="n">response</span><span class="p">.</span><span class="na">code</span><span class="p">()</span><span class="si">}</span><span class="s">: </span><span class="si">${</span><span class="n">response</span><span class="p">.</span><span class="na">message</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">Exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Resource</span><span class="p">.</span><span class="na">Error</span><span class="p">(</span><span class="s">&quot;网络请求失败: </span><span class="si">${</span><span class="n">e</span><span class="p">.</span><span class="na">message</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 其他数据操作方法...</span>
<span class="p">}</span>

<span class="c1">// 7. 使用示例 - ViewModel</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">UserViewModel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ViewModel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UserRepository</span><span class="p">()</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">_users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MutableLiveData</span><span class="o">&lt;</span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;&gt;</span><span class="p">()</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">users</span><span class="p">:</span><span class="w"> </span><span class="n">LiveData</span><span class="o">&lt;</span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_users</span>

<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">loadUsers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">_users</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Resource</span><span class="p">.</span><span class="na">Loading</span><span class="p">()</span>
<span class="w">            </span><span class="n">_users</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">getUsers</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 8. 使用示例 - Activity/Fragment</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">UserListActivity</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">AppCompatActivity</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">viewModel</span><span class="p">:</span><span class="w"> </span><span class="n">UserViewModel</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">viewModels</span><span class="p">()</span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span><span class="w"> </span><span class="n">Bundle?)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
<span class="w">        </span><span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">layout</span><span class="p">.</span><span class="na">activity_user_list</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 观察数据变化</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="na">users</span><span class="p">.</span><span class="na">observe</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">is</span><span class="w"> </span><span class="n">Resource</span><span class="p">.</span><span class="na">Loading</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">showLoading</span><span class="p">()</span>
<span class="w">                </span><span class="k">is</span><span class="w"> </span><span class="n">Resource</span><span class="p">.</span><span class="na">Success</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">showUsers</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">data</span><span class="p">)</span>
<span class="w">                </span><span class="k">is</span><span class="w"> </span><span class="n">Resource</span><span class="p">.</span><span class="na">Error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">showError</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="na">message</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 加载数据</span>
<span class="w">        </span><span class="n">viewModel</span><span class="p">.</span><span class="na">loadUsers</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这个网络框架设计基于OkHttp和Retrofit，具有以下特点，使其更方便开发人员调用：</p>
<h3 id="_37">主要组件和优势<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>NetworkManager单例</strong>：</li>
<li>集中管理OkHttp和Retrofit配置</li>
<li>提供创建API服务的简便方法</li>
<li>
<p>统一管理超时、拦截器等通用配置</p>
</li>
<li>
<p><strong>拦截器系统</strong>：</p>
</li>
<li>HeaderInterceptor：添加通用头部信息</li>
<li>LoggingInterceptor：自动记录请求和响应日志</li>
<li>
<p>ErrorInterceptor：统一处理常见错误码</p>
</li>
<li>
<p><strong>资源封装类Resource</strong>：</p>
</li>
<li>使用密封类(sealed class)封装不同状态：加载中、成功、错误</li>
<li>
<p>方便UI层判断和显示不同状态</p>
</li>
<li>
<p><strong>仓库层Repository</strong>：</p>
</li>
<li>抽象API调用逻辑</li>
<li>
<p>错误处理和转换</p>
</li>
<li>
<p><strong>协程支持</strong>：</p>
</li>
<li>使用suspend函数处理异步请求</li>
<li>避免回调地狱，代码更简洁</li>
</ol>
<h3 id="_38">使用方式<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p>开发人员只需要三步即可完成网络请求：</p>
<ol>
<li>定义API接口</li>
<li>创建Repository处理业务逻辑</li>
<li>在ViewModel中通过LiveData或Flow观察数据</li>
</ol>
<p>这种设计遵循MVVM架构模式，数据流向清晰，便于测试，并支持各种高级功能如缓存、重试和适配器模式。</p>
<p>你还有其他关于网络框架设计的具体问题吗？</p>
</details>
<h2 id="androidtokenrefresh-tokentokenokhttp">在Android平台设计一个用户token过期，通过Refresh Token自动刷新token的功能。网络框架是Okhttp。<a class="headerlink" href="#androidtokenrefresh-tokentokenokhttp" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<p>我来帮你设计一个在Android平台上使用OkHttp实现的Token过期自动刷新功能。这是一个常见的需求，可以使用OkHttp的Interceptor机制来实现。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 定义Token管理类</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">TokenManager</span><span class="p">(</span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">context</span><span class="p">:</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">sharedPreferences</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="s">&quot;auth_prefs&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">MODE_PRIVATE</span><span class="p">)</span>

<span class="w">    </span><span class="kd">companion</span><span class="w"> </span><span class="kd">object</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">KEY_ACCESS_TOKEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;access_token&quot;</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">KEY_REFRESH_TOKEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;refresh_token&quot;</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">KEY_TOKEN_EXPIRY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;token_expiry&quot;</span>

<span class="w">        </span><span class="nd">@Volatile</span>
<span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">instance</span><span class="p">:</span><span class="w"> </span><span class="n">TokenManager? </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>

<span class="w">        </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getInstance</span><span class="p">(</span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="n">Context</span><span class="p">):</span><span class="w"> </span><span class="n">TokenManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="n">synchronized</span><span class="p">(</span><span class="k">this</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">instance</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="n">TokenManager</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">applicationContext</span><span class="p">).</span><span class="na">also</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">it</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 保存token信息</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">saveTokens</span><span class="p">(</span><span class="n">accessToken</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">refreshToken</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">expiresIn</span><span class="p">:</span><span class="w"> </span><span class="kt">Long</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">expiryTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">expiresIn</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span>
<span class="w">        </span><span class="n">sharedPreferences</span><span class="p">.</span><span class="na">edit</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="n">KEY_ACCESS_TOKEN</span><span class="p">,</span><span class="w"> </span><span class="n">accessToken</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="n">KEY_REFRESH_TOKEN</span><span class="p">,</span><span class="w"> </span><span class="n">refreshToken</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">putLong</span><span class="p">(</span><span class="n">KEY_TOKEN_EXPIRY</span><span class="p">,</span><span class="w"> </span><span class="n">expiryTime</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">apply</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 获取访问token</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getAccessToken</span><span class="p">():</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sharedPreferences</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="n">KEY_ACCESS_TOKEN</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 获取刷新token</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">getRefreshToken</span><span class="p">():</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sharedPreferences</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="n">KEY_REFRESH_TOKEN</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 判断token是否过期</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">isTokenExpired</span><span class="p">():</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">expiryTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sharedPreferences</span><span class="p">.</span><span class="na">getLong</span><span class="p">(</span><span class="n">KEY_TOKEN_EXPIRY</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">expiryTime</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 清除token</span>
<span class="w">    </span><span class="kd">fun</span><span class="w"> </span><span class="nf">clearTokens</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sharedPreferences</span><span class="p">.</span><span class="na">edit</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">KEY_ACCESS_TOKEN</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">KEY_REFRESH_TOKEN</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">KEY_TOKEN_EXPIRY</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">apply</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// API服务接口</span>
<span class="kd">interface</span><span class="w"> </span><span class="nc">AuthService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@POST</span><span class="p">(</span><span class="s">&quot;refresh&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">refreshToken</span><span class="p">(</span><span class="nd">@Body</span><span class="w"> </span><span class="n">request</span><span class="p">:</span><span class="w"> </span><span class="n">RefreshTokenRequest</span><span class="p">):</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">TokenResponse</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="c1">// 请求和响应数据类</span>
<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">RefreshTokenRequest</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">refreshToken</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>
<span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">TokenResponse</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">accessToken</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">refreshToken</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">expiresIn</span><span class="p">:</span><span class="w"> </span><span class="kt">Long</span><span class="p">)</span>

<span class="c1">// 创建全局锁，防止多个并发请求同时刷新Token</span>
<span class="kd">object</span><span class="w"> </span><span class="nc">TokenRefreshLock</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Mutex</span><span class="p">()</span>

<span class="w">    </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">withLock</span><span class="p">(</span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="n">suspend</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">T</span><span class="p">):</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">withLock</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">block</span><span class="p">()</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Token拦截器</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">TokenInterceptor</span><span class="p">(</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">context</span><span class="p">:</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">authService</span><span class="p">:</span><span class="w"> </span><span class="n">AuthService</span><span class="p">,</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">onTokenRefreshFailed</span><span class="p">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span>
<span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Interceptor</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">tokenManager</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">lazy</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">TokenManager</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Throws</span><span class="p">(</span><span class="n">IOException</span><span class="o">::</span><span class="n">class</span><span class="p">)</span>
<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span><span class="w"> </span><span class="n">Interceptor</span><span class="p">.</span><span class="na">Chain</span><span class="p">):</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">originalRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">request</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 如果请求本身是刷新token的请求，直接放行</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">originalRequest</span><span class="p">.</span><span class="na">url</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">&quot;refresh&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">originalRequest</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 添加访问token到请求头</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">requestWithToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addTokenToRequest</span><span class="p">(</span><span class="n">originalRequest</span><span class="p">)</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">requestWithToken</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 处理401错误（Token过期）</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">code</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">401</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">response</span><span class="p">.</span><span class="na">close</span><span class="p">()</span>

<span class="w">            </span><span class="c1">// 尝试刷新Token</span>
<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">newToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runBlocking</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">refreshTokenWhenNeeded</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 如果刷新成功，使用新Token重试请求</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newToken</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">newRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addTokenToRequest</span><span class="p">(</span><span class="n">originalRequest</span><span class="p">)</span>
<span class="w">                </span><span class="n">chain</span><span class="p">.</span><span class="na">proceed</span><span class="p">(</span><span class="n">newRequest</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Token刷新失败，通知应用处理登出逻辑</span>
<span class="w">                </span><span class="n">onTokenRefreshFailed</span><span class="p">()</span>
<span class="w">                </span><span class="n">response</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">response</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 添加Token到请求头</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">addTokenToRequest</span><span class="p">(</span><span class="n">request</span><span class="p">:</span><span class="w"> </span><span class="n">Request</span><span class="p">):</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">accessToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokenManager</span><span class="p">.</span><span class="na">getAccessToken</span><span class="p">()</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">request</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">newBuilder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bearer </span><span class="si">$</span><span class="n">accessToken</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 刷新Token逻辑，使用互斥锁确保并发安全</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">refreshTokenWhenNeeded</span><span class="p">():</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TokenRefreshLock</span><span class="p">.</span><span class="na">withLock</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 双重检查，避免多次刷新</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tokenManager</span><span class="p">.</span><span class="na">isTokenExpired</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="nd">@withLock</span><span class="w"> </span><span class="n">tokenManager</span><span class="p">.</span><span class="na">getAccessToken</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kd">val</span><span class="w"> </span><span class="nv">refreshToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokenManager</span><span class="p">.</span><span class="na">getRefreshToken</span><span class="p">()</span><span class="w"> </span><span class="o">?:</span><span class="w"> </span><span class="k">return</span><span class="nd">@withLock</span><span class="w"> </span><span class="kc">null</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RefreshTokenRequest</span><span class="p">(</span><span class="n">refreshToken</span><span class="p">)</span>
<span class="w">                </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authService</span><span class="p">.</span><span class="na">refreshToken</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">isSuccessful</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">val</span><span class="w"> </span><span class="nv">tokenResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">()</span><span class="o">!!</span>
<span class="w">                    </span><span class="n">tokenManager</span><span class="p">.</span><span class="na">saveTokens</span><span class="p">(</span>
<span class="w">                        </span><span class="n">tokenResponse</span><span class="p">.</span><span class="na">accessToken</span><span class="p">,</span>
<span class="w">                        </span><span class="n">tokenResponse</span><span class="p">.</span><span class="na">refreshToken</span><span class="p">,</span>
<span class="w">                        </span><span class="n">tokenResponse</span><span class="p">.</span><span class="na">expiresIn</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                    </span><span class="k">return</span><span class="nd">@withLock</span><span class="w"> </span><span class="n">tokenResponse</span><span class="p">.</span><span class="na">accessToken</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 刷新失败，清除token</span>
<span class="w">                    </span><span class="n">tokenManager</span><span class="p">.</span><span class="na">clearTokens</span><span class="p">()</span>
<span class="w">                    </span><span class="k">return</span><span class="nd">@withLock</span><span class="w"> </span><span class="kc">null</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="n">Exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 处理网络错误等异常</span>
<span class="w">                </span><span class="n">tokenManager</span><span class="p">.</span><span class="na">clearTokens</span><span class="p">()</span>
<span class="w">                </span><span class="k">return</span><span class="nd">@withLock</span><span class="w"> </span><span class="kc">null</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 配置OkHttpClient</span>
<span class="kd">fun</span><span class="w"> </span><span class="nf">createOkHttpClient</span><span class="p">(</span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">authService</span><span class="p">:</span><span class="w"> </span><span class="n">AuthService</span><span class="p">):</span><span class="w"> </span><span class="n">OkHttpClient</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">OkHttpClient</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">addInterceptor</span><span class="p">(</span><span class="n">TokenInterceptor</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">authService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Token刷新失败的回调，例如跳转到登录页面</span>
<span class="w">            </span><span class="c1">// 这里可以使用EventBus或其他方式通知应用</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// 在应用中使用</span>
<span class="kd">class</span><span class="w"> </span><span class="nc">YourApplication</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Application</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">lateinit</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">okHttpClient</span><span class="p">:</span><span class="w"> </span><span class="n">OkHttpClient</span>

<span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">onCreate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">super</span><span class="p">.</span><span class="na">onCreate</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 创建Retrofit实例</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">retrofit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Retrofit</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">baseUrl</span><span class="p">(</span><span class="s">&quot;https://your-api-base-url.com/&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">addConverterFactory</span><span class="p">(</span><span class="n">GsonConverterFactory</span><span class="p">.</span><span class="na">create</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 创建AuthService</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">authService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">retrofit</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">AuthService</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 创建OkHttpClient</span>
<span class="w">        </span><span class="n">okHttpClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createOkHttpClient</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">authService</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 使用该okHttpClient创建其他Retrofit实例</span>
<span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">apiRetrofit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Retrofit</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">baseUrl</span><span class="p">(</span><span class="s">&quot;https://your-api-base-url.com/&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">client</span><span class="p">(</span><span class="n">okHttpClient</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="na">addConverterFactory</span><span class="p">(</span><span class="n">GsonConverterFactory</span><span class="p">.</span><span class="na">create</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 初始化其他API服务...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这个实现提供了一个完整的Token自动刷新解决方案，主要包含以下几个部分：</p>
<ol>
<li><strong>TokenManager</strong> - 负责保存和管理Token</li>
<li>存储access token、refresh token和过期时间</li>
<li>提供判断token是否过期的方法</li>
<li>
<p>使用单例模式确保全局唯一实例</p>
</li>
<li>
<p><strong>TokenInterceptor</strong> - OkHttp拦截器，实现Token自动刷新</p>
</li>
<li>拦截每个请求，添加认证头</li>
<li>处理401错误，尝试刷新Token</li>
<li>
<p>使用刷新后的Token重新发送原始请求</p>
</li>
<li>
<p><strong>TokenRefreshLock</strong> - 使用Kotlin协程的Mutex实现的并发控制</p>
</li>
<li>防止多个请求同时触发Token刷新</li>
<li>
<p>确保Token刷新过程的线程安全</p>
</li>
<li>
<p><strong>AuthService</strong> - Retrofit接口，用于调用刷新Token的API</p>
</li>
</ol>
<p>实现要点：</p>
<ul>
<li>使用双重检查和互斥锁，避免多个并发请求同时刷新Token</li>
<li>提供Token刷新失败的回调机制，方便应用跳转到登录页面</li>
<li>使用SharedPreferences存储Token信息，确保持久化</li>
<li>支持刷新Token后更新refresh token（某些API会同时更新两种token）</li>
</ul>
<p>要使用此实现，你需要：</p>
<ol>
<li>将代码集成到你的项目中</li>
<li>创建符合你API规范的AuthService接口和数据类</li>
<li>在Application类或依赖注入框架中初始化并使用这个OkHttpClient</li>
</ol>
<p>这个实现基于Kotlin和协程，如果你的项目使用Java，可能需要做一些调整，特别是锁机制部分。</p>
</details>
<h2 id="android10m">Android从网络加载一个10M的图片，说下注意事项<a class="headerlink" href="#android10m" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<p>在Android中从网络加载10M大小的图片需要考虑以下几个关键注意事项:</p>
<ol>
<li><strong>网络请求处理</strong></li>
<li>使用异步加载方式，避免阻塞主线程</li>
<li>实现超时机制和错误重试</li>
<li>
<p>考虑网络状态变化的处理</p>
</li>
<li>
<p><strong>内存管理</strong></p>
</li>
<li>使用位图加载选项(BitmapFactory.Options)降低采样率</li>
<li>根据实际显示尺寸调整加载分辨率</li>
<li>使用RGB_565等内存占用较小的格式替代ARGB_8888</li>
<li>
<p>注意内存泄漏问题，及时回收不用的Bitmap</p>
</li>
<li>
<p><strong>磁盘缓存</strong></p>
</li>
<li>实现磁盘缓存机制避免重复下载</li>
<li>使用LRU算法管理缓存大小</li>
<li>
<p>考虑缓存过期策略</p>
</li>
<li>
<p><strong>UI体验</strong></p>
</li>
<li>添加加载进度显示</li>
<li>实现占位图和错误图</li>
<li>
<p>考虑图片加载动画效果</p>
</li>
<li>
<p><strong>权限要求</strong></p>
</li>
<li>添加网络访问权限(INTERNET)</li>
<li>
<p>若需存储，添加相应存储权限</p>
</li>
<li>
<p><strong>图片库选择</strong></p>
</li>
<li>考虑使用成熟的图片加载库如Glide、Picasso或Coil</li>
<li>
<p>这些库已优化了上述大部分问题</p>
</li>
<li>
<p><strong>性能优化</strong></p>
</li>
<li>使用HTTP缓存头</li>
<li>考虑使用WebP等压缩格式</li>
<li>在合适场景使用图片压缩或者远程服务器图片压缩API</li>
</ol>
<p>您是在开发一个特定应用吗？我可以提供更针对性的建议。</p>
</details>
<h2 id="_39">腾讯文档是如何实现多用户同时读写的？<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<p>实现多用户同时读写文件（如腾讯文档）通常涉及以下几个关键技术和方法：</p>
<h3 id="1_10">1. <strong>分布式系统</strong><a class="headerlink" href="#1_10" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>分布式存储</strong>：文件被分割存储在多个服务器上，确保高可用性和负载均衡。</li>
<li><strong>分布式锁</strong>：使用分布式锁（如Zookeeper、Redis）来协调多用户对文件的并发访问。</li>
</ul>
<h3 id="2-operational-transformation-ot">2. <strong>操作转换（Operational Transformation, OT）</strong><a class="headerlink" href="#2-operational-transformation-ot" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>OT算法</strong>：用于处理并发操作，确保所有用户的修改最终一致。Google Docs早期使用此技术。</li>
<li><strong>冲突解决</strong>：通过算法解决不同用户同时编辑同一部分内容时的冲突。</li>
</ul>
<h3 id="3-conflict-free-replicated-data-types-crdts">3. <strong>冲突自由复制数据类型（Conflict-Free Replicated Data Types, CRDTs）</strong><a class="headerlink" href="#3-conflict-free-replicated-data-types-crdts" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>CRDTs</strong>：一种数据结构，确保在分布式系统中所有副本最终一致，适合实时协作编辑。</li>
</ul>
<h3 id="4_2">4. <strong>版本控制</strong><a class="headerlink" href="#4_2" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>版本管理</strong>：每次修改生成新版本，系统根据版本号合并或解决冲突。</li>
<li><strong>历史记录</strong>：保留所有修改历史，便于回滚和查看更改。</li>
</ul>
<h3 id="5_1">5. <strong>实时通信</strong><a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>WebSocket</strong>：用于实时推送更新，确保用户界面即时刷新。</li>
<li><strong>长轮询</strong>：在WebSocket不可用时，使用长轮询模拟实时通信。</li>
</ul>
<h3 id="6">6. <strong>前端优化</strong><a class="headerlink" href="#6" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>本地缓存</strong>：在用户设备上缓存文件内容，减少服务器请求。</li>
<li><strong>差异更新</strong>：只传输变化部分，减少网络负载。</li>
</ul>
<h3 id="7">7. <strong>权限管理</strong><a class="headerlink" href="#7" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>细粒度权限控制</strong>：根据用户角色控制读写权限，确保数据安全。</li>
</ul>
<h3 id="8">8. <strong>数据一致性</strong><a class="headerlink" href="#8" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>最终一致性</strong>：在分布式系统中，允许短暂不一致，但最终达到一致状态。</li>
<li><strong>强一致性</strong>：通过分布式事务确保每次操作后数据一致。</li>
</ul>
<h3 id="_40">实现步骤<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>用户A编辑文件</strong>：修改通过WebSocket发送到服务器。</li>
<li><strong>服务器处理</strong>：服务器使用OT或CRDT处理并发修改，更新文件版本。</li>
<li><strong>广播更新</strong>：服务器将更新广播给所有在线用户。</li>
<li><strong>用户B接收更新</strong>：用户B的客户端应用更新，界面即时刷新。</li>
</ol>
<h3 id="_41">示例代码（简化）<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1">// WebSocket 客户端</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;wss://example.com/socket&#39;</span><span class="p">);</span>

<span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">    </span><span class="nx">applyUpdateToDocument</span><span class="p">(</span><span class="nx">update</span><span class="p">);</span><span class="w"> </span><span class="c1">// 应用更新到本地文档</span>
<span class="p">};</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">sendUpdate</span><span class="p">(</span><span class="nx">update</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">update</span><span class="p">));</span><span class="w"> </span><span class="c1">// 发送本地更新到服务器</span>
<span class="p">}</span>

<span class="c1">// 服务器端（伪代码）</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">();</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">handleUpdate</span><span class="p">(</span><span class="nx">update</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">transformedUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">transformUpdate</span><span class="p">(</span><span class="nx">update</span><span class="p">);</span><span class="w"> </span><span class="c1">// 使用OT或CRDT处理更新</span>
<span class="w">    </span><span class="nx">clients</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">transformedUpdate</span><span class="p">);</span><span class="w"> </span><span class="c1">// 广播更新给其他客户端</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_42">总结<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>腾讯文档等多用户实时协作工具通过分布式系统、OT/CRDT算法、实时通信和版本控制等技术实现多用户同时读写。这些技术确保数据一致性、实时性和高可用性。</p>
</details>
<h2 id="android_2">设计一个视频加密功能，涉及服务端和Android端<a class="headerlink" href="#android_2" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<p>我将为您设计一个视频加密功能，包括服务端和Android端的实现。</p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * 视频加密系统设计</span>
<span class="cm"> * 包含服务端和Android客户端实现</span>
<span class="cm"> */</span>

<span class="c1">// ================ 服务端实现 ================</span>

<span class="cm">/**</span>
<span class="cm"> * 服务端视频加密服务</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VideoEncryptionService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">AES_ALGORITHM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AES/CBC/PKCS5Padding&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">KEY_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 生成用户专属加密密钥</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserEncryptionKey</span><span class="w"> </span><span class="nf">generateUserKey</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">KeyGenerator</span><span class="w"> </span><span class="n">keyGen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AES&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">keyGen</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">KEY_SIZE</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">());</span>
<span class="w">            </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">secretKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">keyGen</span><span class="p">.</span><span class="na">generateKey</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// 生成初始化向量</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">16</span><span class="o">]</span><span class="p">;</span>
<span class="w">            </span><span class="n">SecureRandom</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureRandom</span><span class="p">();</span>
<span class="w">            </span><span class="n">random</span><span class="p">.</span><span class="na">nextBytes</span><span class="p">(</span><span class="n">iv</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 保存用户密钥和IV到数据库</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">encodedKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">secretKey</span><span class="p">.</span><span class="na">getEncoded</span><span class="p">());</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">encodedIV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">getEncoder</span><span class="p">().</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">iv</span><span class="p">);</span>
<span class="w">            </span><span class="n">saveUserKeyToDatabase</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">encodedKey</span><span class="p">,</span><span class="w"> </span><span class="n">encodedIV</span><span class="p">);</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserEncryptionKey</span><span class="p">(</span><span class="n">encodedKey</span><span class="p">,</span><span class="w"> </span><span class="n">encodedIV</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">NoSuchAlgorithmException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Failed to generate encryption key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 加密视频文件</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">encryptVideo</span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">videoFile</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 获取用户密钥</span>
<span class="w">            </span><span class="n">UserEncryptionKey</span><span class="w"> </span><span class="n">userKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getUserKeyFromDatabase</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userKey</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;No encryption key found for user: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 解码密钥和IV</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">keyBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">getDecoder</span><span class="p">().</span><span class="na">decode</span><span class="p">(</span><span class="n">userKey</span><span class="p">.</span><span class="na">getEncodedKey</span><span class="p">());</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ivBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">getDecoder</span><span class="p">().</span><span class="na">decode</span><span class="p">(</span><span class="n">userKey</span><span class="p">.</span><span class="na">getEncodedIV</span><span class="p">());</span>

<span class="w">            </span><span class="c1">// 初始化加密器</span>
<span class="w">            </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">secretKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecretKeySpec</span><span class="p">(</span><span class="n">keyBytes</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AES&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">IvParameterSpec</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IvParameterSpec</span><span class="p">(</span><span class="n">ivBytes</span><span class="p">);</span>
<span class="w">            </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">AES_ALGORITHM</span><span class="p">);</span>
<span class="w">            </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">secretKey</span><span class="p">,</span><span class="w"> </span><span class="n">iv</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 生成加密后的文件路径</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">encryptedFilePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateEncryptedFilePath</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 加密并写入文件</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">videoFile</span><span class="p">;</span>
<span class="w">                </span><span class="n">OutputStream</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">encryptedFilePath</span><span class="p">);</span>
<span class="w">                </span><span class="n">CipherOutputStream</span><span class="w"> </span><span class="n">cipherOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CipherOutputStream</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">cipher</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">8192</span><span class="o">]</span><span class="p">;</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">cipherOut</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">cipherOut</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 记录加密日志</span>
<span class="w">            </span><span class="n">logEncryption</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">encryptedFilePath</span><span class="p">);</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">encryptedFilePath</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Failed to encrypt video&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 为用户生成解密令牌</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateDecryptionToken</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">expirationTimeMs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 创建JWT令牌，包含用户ID、视频ID和过期时间</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createJWT</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">expirationTimeMs</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">token</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 内部辅助方法</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveUserKeyToDatabase</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">encodedKey</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">encodedIV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现数据库存储逻辑</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UserEncryptionKey</span><span class="w"> </span><span class="nf">getUserKeyFromDatabase</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现从数据库获取用户密钥</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="c1">// 替换为实际实现</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">generateEncryptedFilePath</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 为加密文件生成存储路径</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;encrypted_videos/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;.enc&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logEncryption</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">filePath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 记录加密操作</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">createJWT</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">expirationTimeMs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现JWT令牌生成</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;jwt_token&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// 替换为实际实现</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 用户加密密钥数据类</span>
<span class="cm"> */</span>
<span class="kd">class</span> <span class="nc">UserEncryptionKey</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">encodedKey</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">encodedIV</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">UserEncryptionKey</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">encodedKey</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">encodedIV</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">encodedKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encodedKey</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">encodedIV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">encodedIV</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEncodedKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">encodedKey</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getEncodedIV</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">encodedIV</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ================ Android客户端实现 ================</span>

<span class="cm">/**</span>
<span class="cm"> * Android视频加密管理器</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">VideoEncryptionManager</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">AES_ALGORITHM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AES/CBC/PKCS5Padding&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">SHARED_PREFS_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;video_encryption_prefs&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KEY_USER_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user_key&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">KEY_USER_IV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user_iv&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ApiService</span><span class="w"> </span><span class="n">apiService</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">VideoEncryptionManager</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">ApiService</span><span class="w"> </span><span class="n">apiService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">apiService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">apiService</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 初始化加密密钥</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initializeEncryption</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">EncryptionCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 检查是否已有密钥</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hasEncryptionKey</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">callback</span><span class="p">.</span><span class="na">onSuccess</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 从服务器获取新密钥</span>
<span class="w">        </span><span class="n">apiService</span><span class="p">.</span><span class="na">requestEncryptionKey</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ApiCallback</span><span class="o">&lt;</span><span class="n">UserEncryptionKey</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nd">@Override</span>
<span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onSuccess</span><span class="p">(</span><span class="n">UserEncryptionKey</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 保存密钥到安全存储</span>
<span class="w">                </span><span class="n">saveEncryptionKey</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="w">                </span><span class="n">callback</span><span class="p">.</span><span class="na">onSuccess</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nd">@Override</span>
<span class="w">            </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onFailure</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">callback</span><span class="p">.</span><span class="na">onError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 播放加密视频</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">playEncryptedVideo</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">SurfaceView</span><span class="w"> </span><span class="n">surfaceView</span><span class="p">,</span><span class="w"> </span><span class="n">PlaybackCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 获取存储的密钥</span>
<span class="w">            </span><span class="n">UserEncryptionKey</span><span class="w"> </span><span class="n">userKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getStoredEncryptionKey</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">userKey</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;No encryption key available&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 使用令牌获取加密视频流</span>
<span class="w">            </span><span class="n">apiService</span><span class="p">.</span><span class="na">getEncryptedVideoStream</span><span class="p">(</span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ApiCallback</span><span class="o">&lt;</span><span class="n">InputStream</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nd">@Override</span>
<span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onSuccess</span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">encryptedStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// 解码密钥和IV</span>
<span class="w">                        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">keyBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">userKey</span><span class="p">.</span><span class="na">getEncodedKey</span><span class="p">(),</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>
<span class="w">                        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ivBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">userKey</span><span class="p">.</span><span class="na">getEncodedIV</span><span class="p">(),</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>

<span class="w">                        </span><span class="c1">// 初始化解密器</span>
<span class="w">                        </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">secretKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecretKeySpec</span><span class="p">(</span><span class="n">keyBytes</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;AES&quot;</span><span class="p">);</span>
<span class="w">                        </span><span class="n">IvParameterSpec</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IvParameterSpec</span><span class="p">(</span><span class="n">ivBytes</span><span class="p">);</span>
<span class="w">                        </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">AES_ALGORITHM</span><span class="p">);</span>
<span class="w">                        </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">secretKey</span><span class="p">,</span><span class="w"> </span><span class="n">iv</span><span class="p">);</span>

<span class="w">                        </span><span class="c1">// 创建解密流</span>
<span class="w">                        </span><span class="n">CipherInputStream</span><span class="w"> </span><span class="n">cipherInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CipherInputStream</span><span class="p">(</span><span class="n">encryptedStream</span><span class="p">,</span><span class="w"> </span><span class="n">cipher</span><span class="p">);</span>

<span class="w">                        </span><span class="c1">// 设置媒体播放器</span>
<span class="w">                        </span><span class="n">setupMediaPlayer</span><span class="p">(</span><span class="n">cipherInputStream</span><span class="p">,</span><span class="w"> </span><span class="n">surfaceView</span><span class="p">,</span><span class="w"> </span><span class="n">callback</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">callback</span><span class="p">.</span><span class="na">onError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="nd">@Override</span>
<span class="w">                </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onFailure</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">callback</span><span class="p">.</span><span class="na">onError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">callback</span><span class="p">.</span><span class="na">onError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 设置媒体播放器播放解密内容</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setupMediaPlayer</span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">decryptedStream</span><span class="p">,</span><span class="w"> </span><span class="n">SurfaceView</span><span class="w"> </span><span class="n">surfaceView</span><span class="p">,</span><span class="w"> </span><span class="n">PlaybackCallback</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 将解密流写入临时文件</span>
<span class="w">            </span><span class="n">File</span><span class="w"> </span><span class="n">tempFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createTempFile</span><span class="p">();</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decryptedStream</span><span class="p">;</span>
<span class="w">                </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">tempFile</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="mi">8192</span><span class="o">]</span><span class="p">;</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">;</span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">bytesRead</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">out</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">bytesRead</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 创建媒体播放器</span>
<span class="w">            </span><span class="n">MediaPlayer</span><span class="w"> </span><span class="n">mediaPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MediaPlayer</span><span class="p">();</span>
<span class="w">            </span><span class="n">mediaPlayer</span><span class="p">.</span><span class="na">setDataSource</span><span class="p">(</span><span class="n">tempFile</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">());</span>
<span class="w">            </span><span class="n">mediaPlayer</span><span class="p">.</span><span class="na">setSurface</span><span class="p">(</span><span class="n">surfaceView</span><span class="p">.</span><span class="na">getHolder</span><span class="p">().</span><span class="na">getSurface</span><span class="p">());</span>
<span class="w">            </span><span class="n">mediaPlayer</span><span class="p">.</span><span class="na">setOnPreparedListener</span><span class="p">(</span><span class="n">mp</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">mp</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
<span class="w">                </span><span class="n">callback</span><span class="p">.</span><span class="na">onStarted</span><span class="p">();</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="n">mediaPlayer</span><span class="p">.</span><span class="na">setOnCompletionListener</span><span class="p">(</span><span class="n">mp</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 播放完成后删除临时文件</span>
<span class="w">                </span><span class="n">tempFile</span><span class="p">.</span><span class="na">delete</span><span class="p">();</span>
<span class="w">                </span><span class="n">callback</span><span class="p">.</span><span class="na">onCompleted</span><span class="p">();</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="n">mediaPlayer</span><span class="p">.</span><span class="na">setOnErrorListener</span><span class="p">((</span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="n">what</span><span class="p">,</span><span class="w"> </span><span class="n">extra</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">callback</span><span class="p">.</span><span class="na">onError</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;MediaPlayer error: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">what</span><span class="p">));</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="n">mediaPlayer</span><span class="p">.</span><span class="na">prepareAsync</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">callback</span><span class="p">.</span><span class="na">onError</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 创建临时文件</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="nf">createTempFile</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">cacheDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getCacheDir</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">File</span><span class="p">.</span><span class="na">createTempFile</span><span class="p">(</span><span class="s">&quot;decrypt_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.tmp&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cacheDir</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 检查是否已有加密密钥</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">hasEncryptionKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SharedPreferences</span><span class="w"> </span><span class="n">prefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="n">SHARED_PREFS_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">MODE_PRIVATE</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">prefs</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">KEY_USER_KEY</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">prefs</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">KEY_USER_IV</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 保存加密密钥</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">saveEncryptionKey</span><span class="p">(</span><span class="n">UserEncryptionKey</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 在实际应用中，应使用Android Keystore来安全存储密钥</span>
<span class="w">        </span><span class="n">SharedPreferences</span><span class="w"> </span><span class="n">prefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="n">SHARED_PREFS_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">MODE_PRIVATE</span><span class="p">);</span>
<span class="w">        </span><span class="n">prefs</span><span class="p">.</span><span class="na">edit</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="n">KEY_USER_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">getEncodedKey</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="n">KEY_USER_IV</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">getEncodedIV</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="na">apply</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 获取存储的加密密钥</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">UserEncryptionKey</span><span class="w"> </span><span class="nf">getStoredEncryptionKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SharedPreferences</span><span class="w"> </span><span class="n">prefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="n">SHARED_PREFS_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">MODE_PRIVATE</span><span class="p">);</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="n">KEY_USER_KEY</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="n">KEY_USER_IV</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserEncryptionKey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">iv</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 回调接口</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">EncryptionCallback</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">onSuccess</span><span class="p">();</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">onError</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">PlaybackCallback</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">onStarted</span><span class="p">();</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">onCompleted</span><span class="p">();</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">onError</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * API服务接口</span>
<span class="cm"> */</span>
<span class="kd">interface</span> <span class="nc">ApiService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">requestEncryptionKey</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">ApiCallback</span><span class="o">&lt;</span><span class="n">UserEncryptionKey</span><span class="o">&gt;</span><span class="w"> </span><span class="n">callback</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">getEncryptedVideoStream</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">videoId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">ApiCallback</span><span class="o">&lt;</span><span class="n">InputStream</span><span class="o">&gt;</span><span class="w"> </span><span class="n">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * API回调接口</span>
<span class="cm"> */</span>
<span class="kd">interface</span> <span class="nc">ApiCallback</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onSuccess</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">onFailure</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 安全增强的实现 - 使用Android Keystore保护加密密钥</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SecureKeyManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">MASTER_KEY_ALIAS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;video_encryption_master_key&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ANDROID_KEYSTORE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;AndroidKeyStore&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 使用Android Keystore安全存储加密密钥</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">securelyStoreKey</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">UserEncryptionKey</span><span class="w"> </span><span class="n">userKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 创建或获取主密钥</span>
<span class="w">            </span><span class="n">KeyStore</span><span class="w"> </span><span class="n">keyStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">ANDROID_KEYSTORE</span><span class="p">);</span>
<span class="w">            </span><span class="n">keyStore</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">keyStore</span><span class="p">.</span><span class="na">containsAlias</span><span class="p">(</span><span class="n">MASTER_KEY_ALIAS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">KeyGenerator</span><span class="w"> </span><span class="n">keyGenerator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyGenerator</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span>
<span class="w">                        </span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">KEY_ALGORITHM_AES</span><span class="p">,</span>
<span class="w">                        </span><span class="n">ANDROID_KEYSTORE</span><span class="p">);</span>

<span class="w">                </span><span class="n">keyGenerator</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">KeyGenParameterSpec</span><span class="p">.</span><span class="na">Builder</span><span class="p">(</span>
<span class="w">                        </span><span class="n">MASTER_KEY_ALIAS</span><span class="p">,</span>
<span class="w">                        </span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">PURPOSE_ENCRYPT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">PURPOSE_DECRYPT</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setBlockModes</span><span class="p">(</span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">BLOCK_MODE_GCM</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setEncryptionPaddings</span><span class="p">(</span><span class="n">KeyProperties</span><span class="p">.</span><span class="na">ENCRYPTION_PADDING_NONE</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">setKeySize</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>

<span class="w">                </span><span class="n">keyGenerator</span><span class="p">.</span><span class="na">generateKey</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 获取主密钥</span>
<span class="w">            </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">masterKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SecretKey</span><span class="p">)</span><span class="w"> </span><span class="n">keyStore</span><span class="p">.</span><span class="na">getKey</span><span class="p">(</span><span class="n">MASTER_KEY_ALIAS</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 加密用户密钥</span>
<span class="w">            </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AES/GCM/NoPadding&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">masterKey</span><span class="p">);</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">getIV</span><span class="p">();</span>

<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">keyBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">userKey</span><span class="p">.</span><span class="na">getEncodedKey</span><span class="p">(),</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ivBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">userKey</span><span class="p">.</span><span class="na">getEncodedIV</span><span class="p">(),</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>

<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">encryptedKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">keyBytes</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 重新初始化加密器，加密IV</span>
<span class="w">            </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">ENCRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">masterKey</span><span class="p">);</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ivForIV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">getIV</span><span class="p">();</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">encryptedIV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">ivBytes</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 保存加密后的密钥、IV以及加密这些值所用的IV</span>
<span class="w">            </span><span class="n">SharedPreferences</span><span class="w"> </span><span class="n">prefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="s">&quot;secure_video_keys&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">MODE_PRIVATE</span><span class="p">);</span>
<span class="w">            </span><span class="n">prefs</span><span class="p">.</span><span class="na">edit</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="s">&quot;encrypted_key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">encryptedKey</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="s">&quot;encrypted_iv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">encryptedIV</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="s">&quot;key_iv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">putString</span><span class="p">(</span><span class="s">&quot;iv_iv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">ivForIV</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">))</span>
<span class="w">                </span><span class="p">.</span><span class="na">apply</span><span class="p">();</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Failed to securely store encryption key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * 安全获取存储的加密密钥</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserEncryptionKey</span><span class="w"> </span><span class="nf">securelyRetrieveKey</span><span class="p">(</span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">SharedPreferences</span><span class="w"> </span><span class="n">prefs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="s">&quot;secure_video_keys&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">MODE_PRIVATE</span><span class="p">);</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">encryptedKeyStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;encrypted_key&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">encryptedIVStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;encrypted_iv&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">keyIVStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;key_iv&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">ivIVStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prefs</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&quot;iv_iv&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">encryptedKeyStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">encryptedIVStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">keyIVStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ivIVStr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 获取主密钥</span>
<span class="w">            </span><span class="n">KeyStore</span><span class="w"> </span><span class="n">keyStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KeyStore</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="n">ANDROID_KEYSTORE</span><span class="p">);</span>
<span class="w">            </span><span class="n">keyStore</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">            </span><span class="n">SecretKey</span><span class="w"> </span><span class="n">masterKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SecretKey</span><span class="p">)</span><span class="w"> </span><span class="n">keyStore</span><span class="p">.</span><span class="na">getKey</span><span class="p">(</span><span class="n">MASTER_KEY_ALIAS</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 解密密钥</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">encryptedKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">encryptedKeyStr</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">keyIV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">keyIVStr</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>

<span class="w">            </span><span class="n">Cipher</span><span class="w"> </span><span class="n">cipher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cipher</span><span class="p">.</span><span class="na">getInstance</span><span class="p">(</span><span class="s">&quot;AES/GCM/NoPadding&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">GCMParameterSpec</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GCMParameterSpec</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="n">keyIV</span><span class="p">);</span>
<span class="w">            </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">masterKey</span><span class="p">,</span><span class="w"> </span><span class="n">spec</span><span class="p">);</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">keyBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">encryptedKey</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// 解密IV</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">encryptedIV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">encryptedIVStr</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ivIV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">decode</span><span class="p">(</span><span class="n">ivIVStr</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">);</span>

<span class="w">            </span><span class="n">spec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GCMParameterSpec</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="n">ivIV</span><span class="p">);</span>
<span class="w">            </span><span class="n">cipher</span><span class="p">.</span><span class="na">init</span><span class="p">(</span><span class="n">Cipher</span><span class="p">.</span><span class="na">DECRYPT_MODE</span><span class="p">,</span><span class="w"> </span><span class="n">masterKey</span><span class="p">,</span><span class="w"> </span><span class="n">spec</span><span class="p">);</span>
<span class="w">            </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">ivBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipher</span><span class="p">.</span><span class="na">doFinal</span><span class="p">(</span><span class="n">encryptedIV</span><span class="p">);</span>

<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserEncryptionKey</span><span class="p">(</span>
<span class="w">                    </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">keyBytes</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">),</span>
<span class="w">                    </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeToString</span><span class="p">(</span><span class="n">ivBytes</span><span class="p">,</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">));</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Failed to retrieve encryption key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>我设计的视频加密系统涵盖了以下关键组件和功能：</p>
<h2 id="_43">服务端部分<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>VideoEncryptionService 类</strong></li>
<li>生成用户专属的AES-256加密密钥和初始化向量(IV)</li>
<li>对上传的视频文件进行加密处理</li>
<li>
<p>为用户生成解密令牌(JWT)，用于授权访问加密视频</p>
</li>
<li>
<p><strong>安全存储</strong></p>
</li>
<li>用户密钥和IV安全存储在数据库中</li>
<li>加密视频存储在服务器的安全目录中</li>
</ol>
<h2 id="android_3">Android客户端部分<a class="headerlink" href="#android_3" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>VideoEncryptionManager 类</strong></li>
<li>处理与服务器的密钥交换</li>
<li>管理本地存储的加密密钥</li>
<li>
<p>提供加密视频播放功能</p>
</li>
<li>
<p><strong>安全增强措施</strong></p>
</li>
<li>SecureKeyManager 类利用Android Keystore系统安全存储用户密钥</li>
<li>使用主密钥对用户加密密钥进行二次加密保护</li>
<li>
<p>临时文件处理确保解密内容不会被持久化存储</p>
</li>
<li>
<p><strong>播放机制</strong></p>
</li>
<li>使用CipherInputStream实时解密视频流</li>
<li>集成MediaPlayer播放解密后的视频内容</li>
</ol>
<h2 id="_44">系统优势<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>端到端加密</strong>：视频在服务器端加密，仅在客户端播放时解密</li>
<li><strong>用户绑定</strong>：加密密钥与用户账号绑定，确保只有授权用户可访问</li>
<li><strong>时效性控制</strong>：通过JWT令牌实现访问时效控制</li>
<li><strong>密钥保护</strong>：利用Android Keystore保护客户端存储的密钥</li>
</ol>
<p>这个设计可以根据您的具体需求进行调整。您需要具体实现什么样的加密级别或有其他特殊需求吗？</p>
</details>
<h2 id="mp4alpha">mp4播放alpha视频实现的原理<a class="headerlink" href="#mp4alpha" title="Permanent link">&para;</a></h2>
<details class="answer">
<summary>答案</summary>
<p>MP4视频播放Alpha通道（透明度）的实现原理涉及视频编码、解码和渲染的多个技术方面。我来解释一下这个过程：</p>
<h2 id="alphamp4">Alpha通道在MP4中的实现原理<a class="headerlink" href="#alphamp4" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>编码层面</strong>：</li>
<li>MP4容器格式本身支持存储带有Alpha通道的视频</li>
<li>
<p>常用的实现方法有两种：</p>
<ul>
<li>分离Alpha：将RGB和Alpha分开编码为两个视频流</li>
<li>集成Alpha：将Alpha通道作为视频的第四个通道一起编码</li>
</ul>
</li>
<li>
<p><strong>常见的编码方案</strong>：</p>
</li>
<li>H.264/AVC + Alpha：使用标准H.264编码RGB部分，另一个H.264流编码Alpha通道</li>
<li>HEVC/H.265 + Alpha：较新的标准，对Alpha支持更好，压缩效率更高</li>
<li>ProRes 4444：Apple的专业编解码器，原生支持Alpha通道</li>
<li>
<p>VP8/VP9：Google的开源编解码器，也支持Alpha通道</p>
</li>
<li>
<p><strong>渲染实现</strong>：</p>
</li>
<li>解码后获取RGB图像数据和Alpha数据</li>
<li>在渲染过程中应用Alpha混合算法：C = C_fg * Alpha + C_bg * (1-Alpha)</li>
<li>
<p>通过GPU加速实现实时Alpha混合</p>
</li>
<li>
<p><strong>应用层面的实现</strong>：</p>
</li>
<li>低级实现：使用OpenGL/DirectX等图形API手动实现Alpha混合</li>
<li>高级实现：使用媒体框架如AVFoundation、MediaFoundation等处理带Alpha的视频</li>
</ol>
<p>在实际应用中，渲染带Alpha通道的MP4视频需要特殊的播放器或框架支持，普通的视频播放器可能无法正确显示Alpha通道。</p>
<h1 id="androidalpha">Android平台上播放Alpha通道视频的实现方法<a class="headerlink" href="#androidalpha" title="Permanent link">&para;</a></h1>
<p>Android平台上播放带Alpha通道(透明度)的视频有几种常见实现方式，每种方法有其优缺点：</p>
<h2 id="1-surfaceviewmediacodec">1. 使用SurfaceView和MediaCodec<a class="headerlink" href="#1-surfaceviewmediacodec" title="Permanent link">&para;</a></h2>
<p>这是一种低级别但高效的实现方式：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 基本实现流程</span>
<span class="n">MediaExtractor</span><span class="w"> </span><span class="n">extractor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MediaExtractor</span><span class="p">();</span>
<span class="n">extractor</span><span class="p">.</span><span class="na">setDataSource</span><span class="p">(</span><span class="n">videoPath</span><span class="p">);</span>
<span class="c1">// 获取视频轨道</span>
<span class="kt">int</span><span class="w"> </span><span class="n">videoTrackIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findTrackIndex</span><span class="p">(</span><span class="n">extractor</span><span class="p">);</span>

<span class="n">MediaCodec</span><span class="w"> </span><span class="n">decoder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">createDecoderByType</span><span class="p">(</span><span class="n">mimeType</span><span class="p">);</span>
<span class="c1">// 配置解码器</span>
<span class="n">decoder</span><span class="p">.</span><span class="na">configure</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="n">decoder</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>

<span class="c1">// 在循环中解码帧并使用OpenGL ES渲染</span>
<span class="c1">// 使用shader处理Alpha混合</span>
</code></pre></div>
<p>优点：性能好，可以精确控制渲染过程
缺点：实现复杂，需要手写OpenGL ES代码处理Alpha</p>
<h2 id="2-exoplayer">2. 使用ExoPlayer<a class="headerlink" href="#2-exoplayer" title="Permanent link">&para;</a></h2>
<p>ExoPlayer是Google提供的高级媒体播放器库，更容易实现：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 准备ExoPlayer</span>
<span class="n">ExoPlayer</span><span class="w"> </span><span class="n">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ExoPlayer</span><span class="p">.</span><span class="na">Builder</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>

<span class="c1">// 设置媒体源</span>
<span class="n">MediaSource</span><span class="w"> </span><span class="n">mediaSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProgressiveMediaSource</span><span class="p">.</span><span class="na">Factory</span><span class="p">(</span><span class="n">dataSourceFactory</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="na">createMediaSource</span><span class="p">(</span><span class="n">MediaItem</span><span class="p">.</span><span class="na">fromUri</span><span class="p">(</span><span class="n">videoUri</span><span class="p">));</span>

<span class="c1">// 配置渲染器</span>
<span class="n">player</span><span class="p">.</span><span class="na">setMediaSource</span><span class="p">(</span><span class="n">mediaSource</span><span class="p">);</span>

<span class="c1">// 设置自定义的Surface</span>
<span class="n">SurfaceView</span><span class="w"> </span><span class="n">surfaceView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">surface_view</span><span class="p">);</span>
<span class="n">player</span><span class="p">.</span><span class="na">setVideoSurfaceView</span><span class="p">(</span><span class="n">surfaceView</span><span class="p">);</span>

<span class="c1">// 实现一个自定义Renderer来处理Alpha通道</span>
<span class="c1">// 通常需要自定义Shader</span>
</code></pre></div>
<p>ExoPlayer可以通过扩展其渲染器来支持Alpha通道视频。</p>
<h2 id="3_9">3. 使用两个视频流方法<a class="headerlink" href="#3_9" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="c1">// 加载两个视频 - 一个是RGB内容，一个是Alpha掩码</span>
<span class="n">VideoView</span><span class="w"> </span><span class="n">rgbView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">rgb_video</span><span class="p">);</span>
<span class="n">VideoView</span><span class="w"> </span><span class="n">alphaView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">alpha_video</span><span class="p">);</span>

<span class="c1">// 设置Alpha掩码视频作为RGB视频的Alpha通道</span>
<span class="c1">// 可以通过自定义View或使用PorterDuff混合模式实现</span>
</code></pre></div>
<p>优点：实现简单，使用标准组件
缺点：需要准备两个单独的视频文件，同步可能会有问题</p>
<h2 id="4-textureview">4. 使用TextureView和自定义混合<a class="headerlink" href="#4-textureview" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">TextureView</span><span class="w"> </span><span class="n">textureView</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findViewById</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="na">id</span><span class="p">.</span><span class="na">texture_view</span><span class="p">);</span>
<span class="n">textureView</span><span class="p">.</span><span class="na">setSurfaceTextureListener</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TextureView</span><span class="p">.</span><span class="na">SurfaceTextureListener</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onSurfaceTextureAvailable</span><span class="p">(</span><span class="n">SurfaceTexture</span><span class="w"> </span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 初始化MediaPlayer</span>
<span class="w">        </span><span class="n">mediaPlayer</span><span class="p">.</span><span class="na">setSurface</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Surface</span><span class="p">(</span><span class="n">surface</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// 设置自定义shader以处理Alpha通道</span>
<span class="w">        </span><span class="c1">// 通常通过GLSurfaceView或自定义渲染器实现</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 其他回调方法...</span>
<span class="p">});</span>
</code></pre></div>
<h2 id="_45">实际工程实现建议<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>文件格式选择</strong>：</li>
<li>使用WebM (VP8/VP9) 格式，Android原生支持较好</li>
<li>
<p>或使用特殊编码的MP4，如H.264+Alpha</p>
</li>
<li>
<p><strong>编码方式</strong>：</p>
</li>
<li>预乘Alpha方式编码视频效果更好</li>
<li>
<p>推荐视频尺寸是2的幂次方，以优化GPU渲染</p>
</li>
<li>
<p><strong>渲染优化</strong>：</p>
</li>
<li>优先使用硬件加速</li>
<li>考虑使用OpenGL ES着色器直接在GPU中处理Alpha混合</li>
</ol>
<p>您需要具体针对哪种方案的更详细实现，或者有其他特定问题需要解答吗？</p>
</details>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "search.highlight", "content.code.copy", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../js/custom.js"></script>
      
    
  </body>
</html>